<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cooperxj.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="记录一些学习笔记、小说、随笔">
<meta property="og:type" content="website">
<meta property="og:title" content="Cooper Notes">
<meta property="og:url" content="http://cooperxj.github.io/page/20/index.html">
<meta property="og:site_name" content="Cooper Notes">
<meta property="og:description" content="记录一些学习笔记、小说、随笔">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Cooper">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://cooperxj.github.io/page/20/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Cooper Notes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Cooper Notes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">obey rules</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/Internet%E6%8E%A5%E5%85%A5%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/Internet%E6%8E%A5%E5%85%A5%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">Internet接入控制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-13 09:11:11" itemprop="dateModified" datetime="2021-02-13T09:11:11+08:00">2021-02-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">密码学</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/Internet%E6%8E%A5%E5%85%A5%E6%8E%A7%E5%88%B6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/Internet%E6%8E%A5%E5%85%A5%E6%8E%A7%E5%88%B6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>375</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>接入过程</p>
<ul>
<li>建立终端A与接入控制设备之间的传输路径</li>
<li>接入控制设备完成身份鉴别过程</li>
<li>动态配置终端A的网络信息</li>
<li>动态创建终端A的网络路由项</li>
</ul>
</li>
<li><p>控制接入协议</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210106202245.png" alt="image-20210106202241082" style="zoom:50%;" /></li>
<li><p>扩展鉴别协议EAP产生背景</p>
<p>由于各种链路层协议需要支持每一中鉴别协议，导致现阶段这种解决方案越来越复杂。</p>
<p>EAP是一种与应用环境无关的，用户传输鉴别协议消息的载体协议，所有应用环境与鉴别协议都和这种载体协议绑定。</p>
<p>作用：它的出现使得链路层载体协议与鉴别协议机制得以解耦。</p>
<p>EAP报文格式 ：</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210106212050316.png" alt="image-20210106212050316" style="zoom:50%;" />

<p>在标识符字段中需要注意：</p>
<p>要求两次相邻请求的报文中的标识符不一样，用来应对重放攻击。</p>
</li>
<li><p>802.1X鉴别接入用户身份过程</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210106212917.png" alt="image-20210106212912871" style="zoom:50%;" /></li>
<li><p>以太网接入控制过程</p>
<ol>
<li>当某个用户希望接入Internet时，通过发送EAPOL-Start发起鉴别过程</li>
<li>一旦成功完成用户身份鉴别，交换机将该终端的MAC地址列入接收到EAP报文端口对应的访问控制列表并将访问控制设置为允许访问。</li>
</ol>
</li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">网络安全协议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-13 09:10:53" itemprop="dateModified" datetime="2021-02-13T09:10:53+08:00">2021-02-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">密码学</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/%E5%AF%86%E7%A0%81%E5%AD%A6/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>984</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安全体系结构"><a href="#安全体系结构" class="headerlink" title="安全体系结构"></a>安全体系结构</h3><p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210106182607.png" alt="image-20210106182605897"></p>
<h3 id="IPSec"><a href="#IPSec" class="headerlink" title="IPSec"></a>IPSec</h3><blockquote>
<p>组成部分</p>
</blockquote>
<ul>
<li><p>安全关联  SA</p>
<p>与特定通信保护相关联的安全套件集合<br>SA保护单向通信<br>安全关联唯一标识：（安全参数索引（SPI），目的IP地址，安全协议标识符）</p>
<p><strong>如果双方想要通信，必须使用两个SA</strong></p>
<p>小型网络的话可以手动设置</p>
<p>大型网络的话可以通过IKE协议来设置策略</p>
</li>
<li><p>AH（验证算法）</p>
<p>数据完整性验证<br>数据源身份认证<br>防重放攻击</p>
</li>
<li><p>ESP（加密算法）</p>
<p>在AH的基础了增加了加密功能</p>
</li>
<li><p>IKE（策略商量）</p>
</li>
</ul>
<blockquote>
<p>传输模式</p>
</blockquote>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210106155353.png" alt="image-20210106155348920" style="zoom:50%;" />

<p>​    由于ESP只能认证ESP报头到ESP尾部的消息，因此可以添加AH作为其余部分的认证</p>
<blockquote>
<p>隧道模式</p>
</blockquote>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210106155800.png" alt="image-20210106155755812" style="zoom:50%;" />

<p>​    与传输模式相比就是多了一个<font color=red>新的IP报头</font></p>
<h3 id="AH协议"><a href="#AH协议" class="headerlink" title="AH协议"></a>AH协议</h3><p>结构如下：</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210106170022.png" alt="image-20210106170017735" style="zoom:50%;" />

<ul>
<li><p>下一个头</p>
<p>表示紧跟在AH头部的下一个载荷的类型</p>
<p>传输模式下：该字段是处于保护中的传输层协议的值，比如6（TCP）、17（UDP）或者50（ESP）</p>
<p>隧道模式下：AH所保护的是整个IP包，该值是4，表示IP-in-IP协议</p>
</li>
<li><p>负载长度</p>
<p>AH的载荷长度</p>
</li>
<li><p>保留域</p>
<p>将来使用</p>
</li>
<li><p>安全参数索引</p>
<p>与源地址或目的地址以及AH来共同唯一标识一个安全关联（SA）</p>
</li>
<li><p>序列号</p>
<p>抵抗重放攻击</p>
</li>
<li><p>验证数据</p>
<p>是可变长的字段，包含数据包的认证数据——完整性校验值</p>
</li>
</ul>
<h3 id="ESP协议"><a href="#ESP协议" class="headerlink" title="ESP协议"></a>ESP协议</h3><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210106170627.png" alt="image-20210106170622405" style="zoom:50%;" />

<ul>
<li><p>安全参数索引</p>
<p>与目的IP地址、协议一起组成的三元组可以为该IP包唯一地确定一个SA</p>
</li>
<li><p>序列号</p>
<p>抵抗重放攻击</p>
</li>
<li><p>变长</p>
<p>包含了实际的载荷数据。如果采用了加密，该部分就是加密后的密文；如果没有加密，该部分就是明文</p>
</li>
<li><p>填充</p>
<p>填充项的使用是为了保证ESP的边界适合于加密算法的需要</p>
</li>
<li><p>填充长度</p>
<p>指出上面的填充项填充了多少字节的数据，因此，接收端可以恢复出载荷数据的真实长度</p>
</li>
<li><p>下一个头</p>
<p>指明了封装在载荷中的数据类型，例如6表示TCP数据（传送模式），4表示IP-in-IP（隧道模式）</p>
</li>
<li><p>验证数据</p>
<p>它包含数据完整性检验结果（ICV）</p>
</li>
</ul>
<h3 id="IKE"><a href="#IKE" class="headerlink" title="IKE"></a>IKE</h3><ul>
<li><p>静态安全关联</p>
<p>建立机制由人工完成发送端和接收端中安全关联数据库（SAD）的配置过程。</p>
</li>
<li><p>动态安全关联</p>
<p>建立机制根据安全传输数据的需要，通过协议建立发送端至接收端的安全关联，协商与该安全关联相关的参数。</p>
<p>动态建立过程：</p>
<ol>
<li>建立安全传输通道</li>
<li>建立安全关联</li>
</ol>
</li>
</ul>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>在TCP基础上建立TLS安全连接，经过TLS安全连接实现：</p>
<ul>
<li>对Web服务器的身份鉴别</li>
<li>浏览器和Web服务器之间传输的HTTP消息的保密性、完整性和源端鉴别</li>
</ul>
<p>建立https的过程</p>
<ul>
<li>双方约定压缩算法、加密算法、MAC算法等</li>
<li>服务器发送证书链</li>
<li>客户发送预主密钥</li>
<li>双方切换到新的安全参数</li>
<li>保密传输http消息</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/oss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/oss/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-19 09:27:51" itemprop="dateModified" datetime="2021-01-19T09:27:51+08:00">2021-01-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/oss/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/oss/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>976</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Buckets"><a href="#Buckets" class="headerlink" title="Buckets"></a>Buckets</h2><blockquote>
<p>实现方式</p>
</blockquote>
<p>通过命令行注入config常量 （MongoDB的连接、暴露端口以及log等级）</p>
<p>用户通过接口对服务进行调用 （mountpoints.go）</p>
<blockquote>
<p>整体代码逻辑</p>
</blockquote>
<ol>
<li><p>注入常量，脚本启动服务</p>
</li>
<li><p>服务调用</p>
<ul>
<li><p>所有对桶的操作都是在MongoDB中进行增删改查，并没有真正的对桶进行创建</p>
</li>
<li><p>每个接口的调用都需要做认证，也就是签名的认证（我在测试的时候没有找到怎么搞这个签名，直接注释掉了）</p>
</li>
</ul>
</li>
</ol>
<h2 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h2><blockquote>
<p>实现方式</p>
</blockquote>
<p>通过命令行注入config常量 （MongoDB的连接、暴露端口、ceph地址+端口（此处必须是<font color=red>域名模式</font>，否则无法访问ceph的桶）、ceph<font color=red>超级用户</font>的ak和sk、<font color=red>slot的数量</font>以及log等级）</p>
<p>用户通过接口对服务进行调用 （mountpoints.go）</p>
<p><strong>如何进行存储的呢？</strong></p>
<ol>
<li><p>首先也是必须需要做的，就是在创建Object服务的时候会创建底层的NewFilesystemRepository，在初始化的时候会在ceph中创建桶（CephEnsureBuckets方法），桶的数量就是我们之前定的slot的数量，<font color=red>这一步必须要做，否则存储进行桶映射的时候将没有桶</font></p>
</li>
<li><p>根据Object的信息，计算出该Object应该存在哪个桶里面（oss0~ oss(slot-1) ）</p>
</li>
</ol>
<blockquote>
<p>整体代码逻辑</p>
</blockquote>
<ol>
<li>注入常量，脚本启动服务</li>
<li>服务调用<ul>
<li>对Object的所有操作都需要写入到MongoDB中</li>
<li>每次对Object进行操作时，都会与ceph打交道，也就是会调用service/ceph/object.go中的方法</li>
</ul>
</li>
</ol>
<h2 id="Users"><a href="#Users" class="headerlink" title="Users"></a>Users</h2><blockquote>
<p>实现方式</p>
</blockquote>
<p>通过命令行注入config常量 （MongoDB的连接、暴露端口以及log等级）</p>
<p>用户通过接口对服务进行调用 （mountpoints.go）</p>
<blockquote>
<p>整体代码逻辑</p>
</blockquote>
<ol>
<li><p>注入常量，脚本启动服务</p>
</li>
<li><p>服务调用</p>
<ul>
<li><p>所有对User的操作都是在MongoDB中进行增删改查，并没有真正在Ceph中对User进行创建</p>
</li>
<li><p>每个接口的调用都需要做认证，也就是签名的认证</p>
</li>
</ul>
</li>
</ol>
<h3 id="hits"><a href="#hits" class="headerlink" title="hits"></a>hits</h3><ol>
<li><p>services中的服务都是采用的组合的方式进行编写的，例如buckets.go中的BucketRepository大部分方法都是直接使用mongo中的buckets.go方法进行调用，对于有的方法在mongo中对应的服务中没有的则进行了编写</p>
</li>
<li><p>如果Object服务进行重启或者替换，出现桶拒绝创建的情况，则需要先查看原先的桶有没有被删掉，如果没有则需要全部清除</p>
</li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%8D%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%8D%E4%B9%A0/" class="post-title-link" itemprop="url">数据库复习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-13 08:27:13" itemprop="dateModified" datetime="2021-02-13T08:27:13+08:00">2021-02-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%8D%E4%B9%A0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%8D%E4%B9%A0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>690</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>数据库系统（DBMS）</p>
<ul>
<li><p>功能</p>
<p>位于用户与操作系统之间的一层数据管理软件，用于组织、存取和维护数据。有时也被直接称为数据库系统</p>
</li>
<li><p>特点</p>
<p>数据长期存储<br>数据由DBMS统一管理<br>数据共享程度高<br>数据独立性高<br>数据整体结构化，冗余小 </p>
</li>
</ul>
</li>
<li><p>数据库三层模式</p>
<ul>
<li>外模式 (External Schema)：<pre><code>是数据库用户的数据视图，是与某一应用有关的数据表示
一个数据库可有多个外模式
</code></pre>
</li>
<li>模式（Schema)：<pre><code>逻辑级上的视图，是数据库中全体数据的逻辑结构和特征的描述
一个数据库只有一个模式
</code></pre>
</li>
<li>内模式 (Internal Schema)：<pre><code>数据物理结构和存储方式的描述，是数据在数据库内部的表示方式
一个数据库只有一个内模式
</code></pre>
</li>
</ul>
</li>
<li><p>Web数据库应用系统体系结构</p>
<ul>
<li>客户/服务器（Client/Server，C/S）模式</li>
<li>浏览器/服务器（Browser/Server，B/S）模式</li>
</ul>
</li>
<li><p>关系模型的组成要素及其优缺点</p>
<ul>
<li><p>要素</p>
<p>数据（关系）结构、数据（关系）操作、数据（关系）的完整性约束条件</p>
</li>
<li><p>优点</p>
<p>严格的数学理论根据</p>
<p>数据结构简单、清晰，用户易懂易用</p>
<p>存取路径对用户透明</p>
</li>
<li><p>缺点</p>
<p>查询效率不如非关系模型，为了提高性能，必须对用户的查询进行优化，增加了开发数据库管理系统的负担</p>
</li>
</ul>
</li>
<li><p>数据库恢复故障</p>
<p><strong>各类故障对数据库的可能影响</strong> </p>
<p>• <strong>数据库本身</strong>被破坏，使数据库中全部或部分数据丢失 </p>
<p>–<strong>如系统故障、介质故障等</strong> </p>
<p>• <strong>数据库没有被破坏，但因事务的运行被非正常</strong> </p>
<p>终止而使数据库数据失去一致性(正确性)</p>
<p>–<strong>如事务内部故障、系统故障等</strong></p>
</li>
<li><p>可串行化调度的定义</p>
<p>多个事务的并发执行是正确的，当且仅当其结果与按某一次序串行地执行它们时的结果相同</p>
</li>
<li><p>冲突可串行化调度的定义</p>
<p>如果一个调度冲突等价于一个串行调度，我们说该调度是冲突可串行化的</p>
</li>
<li><p>trigger</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210114100911829.png" alt="image-20210114100911829" style="zoom:50%;" /></li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">MySQL锁机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:41:41" itemprop="dateModified" datetime="2021-08-27T22:41:41+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="mysql中的锁"><a href="#mysql中的锁" class="headerlink" title="mysql中的锁"></a>mysql中的锁</h4><ul>
<li><p>锁的分类</p>
<ul>
<li><p>读锁 (共享锁)</p>
<p>针对同一份数据，多个读操作可以同时进行而不会相互影响</p>
</li>
<li><p>写锁 （排他锁）</p>
<p>当前写操作未完成则会阻断其他写锁和读锁</p>
</li>
<li><p>两者兼容情况</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210811104216.png" alt="image-20210811104214216"></p>
</li>
<li><p>意向锁</p>
<p>意向锁在 InnoDB 中是表级锁，用来表达一个事务想要获取什么。</p>
<p><a target="_blank" rel="noopener" href="http://www.dreamwu.com/post-5794.html">意向锁出现的原因</a></p>
<p>意向锁都是表锁</p>
<ul>
<li>意向共享锁（IS Lock）事务想要获得一张表中某几行的共享锁</li>
<li>意向排他锁（IX Lock） 事务想要获得一张表中某几行的排他锁</li>
</ul>
</li>
<li><p>兼容性情况</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210811104821.png" alt="image-20210811104819615"></p>
</li>
</ul>
</li>
<li><p>MySQL中的锁</p>
<ul>
<li><p>表锁（偏读）</p>
<p>偏向myisam存储引擎，开销小，加锁快，无死锁，锁定粒度大，发生锁冲突的概率最高，并发度最低</p>
<p>查看表上加过的锁</p>
<p>show open tables;</p>
<p>当前表添加读锁</p>
<ul>
<li><p>当前加锁表的session无法更新锁定的表，只可以进行查看，如果更新就会报错，必须解锁才能够更新</p>
</li>
<li><p>当前其他seesion可以查看当前被锁的表，可以更新其他未被锁的表，如果更新当前被锁的表则需要等待被锁表unlock才能够执行更新操作</p>
</li>
</ul>
<p>当前表添加写锁</p>
<ul>
<li>当前加锁表的session可以查看和更新锁定的表</li>
<li>当前其他seesion无法对被锁的表进行操作</li>
</ul>
<p>查看当前MySQL内部表级锁定的情况</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210224090723.png" alt="image-20210224090718173" style="zoom:50%;" />

<p>table_locks_immediate:产生表级锁定的此处，表示可以立即获取锁的查询次数，每次立即获取锁，值+1</p>
<p>table_locks_waited:出现表级锁定争用而等待的次数（不能立即获取锁的次数，每等待一次值+1）,此值越高则说明存在较严重的表级锁争用情况</p>
<p>myisam的读写锁调度是写优先，因此myisam不适合作为写为主表的引擎</p>
</li>
<li><p>行锁</p>
<ul>
<li><p>偏向InnoDB存储引擎，开销大，加锁慢，会出现死锁，锁定粒度小，发送所冲突的概率最低，并发度也最高</p>
</li>
<li><p><font color=red>InnoDB与myisam的最大两个不同点在于：1. 前者支持事务 2.前者采用行级锁</font></p>
</li>
<li><p>MySQL的隔离机制默认到达可重复读（事务级别）</p>
</li>
<li><p>索引失效时行锁会升级为表锁，比如常见的varchar类型没有添加引号</p>
</li>
<li><p>间隙锁的危害</p>
<p>间隙锁：当我们使用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP）”</p>
<p>危害：因为query执行过程中通过范围查找的话，它会锁定整个范围内的所有索引键值，即使这个键值并不存在。间隙锁有一个致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定的键值范围内的任何数据。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>mysql中查看当前锁的情况</p>
<ul>
<li><p>运行事务</p>
<p><code>select * from information_schema.INNODB_TRX;</code></p>
</li>
<li><p>每张表的上锁情况</p>
<p><code>select * from information_schema.INNODB_LOCKS;</code></p>
</li>
<li><p>等待情况</p>
<p><code>select * from information_schema.INNODB_LOCK_WAITS;</code></p>
</li>
</ul>
</li>
</ul>
<h4 id="mysql中的一些机制"><a href="#mysql中的一些机制" class="headerlink" title="mysql中的一些机制"></a>mysql中的一些机制</h4><ul>
<li><p>一致性非锁定读</p>
<ul>
<li><p>定义</p>
<p>InnoDB通过行多版本控制来读取当前执行时间数据库中行的数据。如果读取的行正在执行delete或update操作，这时读取操作不会因此等待行上锁的释放。相反它会去读取行的一个快照数据。</p>
<p><font color=red>重点：不会去等待行锁的释放，而是直接读取行的快照数据</font></p>
</li>
<li><p>不同隔离程度下的效果</p>
<ul>
<li><p>read committed</p>
<p>对于快照数据，总是读取被锁定行的最新一份快照数据</p>
</li>
<li><p>repeatable read</p>
<p>对于快照数据，总是读取事务开始时的行数据版本</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>一致性锁定读</p>
<ul>
<li><p>select … for update</p>
<p>对读取的行记录加一个x锁</p>
</li>
<li><p>select …lock in share mode</p>
<p>对读取的行记录加一个s锁</p>
</li>
</ul>
</li>
<li><p>自增长</p>
<ul>
<li><p>定义</p>
<p>就是auto——increasement</p>
</li>
<li><p>实现机制</p>
<ul>
<li><p>5.1.22版本之前</p>
<p>实现方式为auto_inc locking</p>
<p>为了提高插入性能，锁不是在一个事务完成之后才释放的，而是在完成对自增长值插入的sql语句立即释放</p>
</li>
<li><p>51.22版本以及之后</p>
<p>提供了一种轻量级的互斥量的自增长实现机制，它会使用互斥量去对内存中的计数器进行累加操作</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>外键和锁</p>
<p>对于外键，如果该列没有添加索引，那么会自动添加一个索引</p>
<p>对于外键的插入或者更新，需要先select父表中的数据。这个select操作不是使用一致性非锁定读，而是使用<strong>一致性锁定读中的select …lock in share mode</strong>方式主动添加一个S锁。</p>
</li>
</ul>
<h4 id="锁带来的问题"><a href="#锁带来的问题" class="headerlink" title="锁带来的问题"></a>锁带来的问题</h4><ul>
<li><p>脏读</p>
<ul>
<li><p>发生场景</p>
<p>在read uncommitted的隔离级别下，会发生脏读</p>
<p>在READ UNCOMMITTED级别, 事务中的修改, 即使还没有提交, 对其他事务也都是可见的; 也就是说事务可以读取未提交的数据, 这也就造成了 <code>脏读(Dirty Read)</code> 的出现。</p>
</li>
<li><p>定义</p>
<p>读取到了脏数据，也就是未提交的数据</p>
</li>
<li><p>原因</p>
<p><code>READ UNCOMMITTED</code>隔离级别下, 读不会加任何锁。而写会加排他锁，并到事务结束之后释放。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在 READ UNCOMMITTED 级别运行的事务不会发出共享锁来防止其他事务修改当前事务读取的数据, 既然不加共享锁了, 那么当前事务所读取的数据自然就可以被其他事务来修改。</span><br><span class="line">而且当前事务要读取其他事务未提交的修改, 也不会被排他锁阻止, 因为排他锁会阻止其他事务再对其锁定的数据加读写锁, <span class="strong">**但是可笑的是, 事务在该隔离级别下去读数据的话根本什么锁都不加, 这就让排他锁无法排它了, 因为它连锁都没有**</span>。</span><br><span class="line">这就导致了事务可以读取未提交的修改, 称为脏读。</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>不可重复读</p>
<ul>
<li><p>发生场景</p>
<p>read commited隔离级别下</p>
</li>
<li><p>定义</p>
<p>在一个事务内多次读取到同一数据的集合</p>
</li>
<li><p>原因</p>
<p>未添加next-key lock</p>
</li>
</ul>
</li>
<li><p>丢失更新</p>
<ul>
<li><p>发生场景</p>
<p>理论上在任何隔离级别下都不会发生导致数据库理论意义上的丢失更新</p>
</li>
<li><p>定义</p>
<p>一个事务的更新操作会被另一个事务的更新操作所覆盖</p>
</li>
<li><p>例子</p>
<p>程序员登录到公司的内部员工系统中进行打卡下班，忽然发现自己信息的性别入职时误写成了“女”，于是顺手修改自己的信息，就在这时HR在浏览全公司的名单发现该程序员的部门录入有误，也开始修改该程序员的信息，就在这时，程序员和HR同时点击了提交（HR比程序员稍微慢一点点）。再次刷新，程序员发现明明自己已经提交成功了，为什么自己的性别怎么还是“女”？</p>
<p>在这个事例中，程序员事务和HR事务都读取了数据，程序员事务修改后先提交了，接着HR事务也修改了并提交。这时程序员这个事务再次查询发现自己刚才做的修改无效，就好像是刚才的更新丢失了，这是因为<font color=red>HR这个事务修改的数据是在HR事务查询到数据的基础上修改的</font>，所以后一次的更新覆盖了前一次的更新。</p>
</li>
<li><p>解决方法</p>
<p>在select的时候加上X锁，例如</p>
<p><code>select ... for update</code></p>
<p>这里注意，一般丢失更新都是发生在查询的基础上，因此在查询到时候需要加上X锁</p>
</li>
</ul>
</li>
</ul>
<h4 id="所带来的现象"><a href="#所带来的现象" class="headerlink" title="所带来的现象"></a>所带来的现象</h4><ul>
<li><p>阻塞</p>
<ul>
<li><p>定义</p>
<p>一个事务需要等待另一个事务中的锁释放</p>
</li>
<li><p>对应参数</p>
<p><code>innodb_lock_wait_timeout</code> -&gt;控制等待的时间（可以在数据库运行时进行调整）</p>
<p><code>innodb_rollback_on_timeout</code>-&gt;是否等待超时时对进行中的事务进行回滚操作（只能在启动前进行修改）</p>
</li>
<li><p>注意事项</p>
<p>在一个事务中，如果有两个操作，其中操作1执行成功，操作2阻塞超时，那么会导致最终的</p>
</li>
</ul>
</li>
<li><p>死锁</p>
<ul>
<li><p>解决死锁的方法</p>
<ul>
<li><p>超时主动放弃，根据FIFO顺序选择回滚对象</p>
</li>
<li><p>等待图主动检索死锁</p>
<p>策略：根据锁的信息链表还有事务等待链表构造出一张图，若该图中存在回路则说明出现了死锁。</p>
<p>检测回路，使用的是非递归的方式，因为效率比递归要高。</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>锁升级</p>
<ul>
<li><p>定义</p>
<p>将锁的粒度降低</p>
</li>
<li><p>InnoDB不存在锁升级问题，因为它不是根据每个记录产生行锁，而是根据每个事务访问的每个页对锁进行管理，采用的是位图的方式。因此不管一个事务锁住页中一个记录还是多个记录，开销都是一样的</p>
<p>行锁在InnoDB中的数据结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_rec_struct</span>        <span class="title">lock_rec_t</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lock_rec_struct</span>&#123;</span></span><br><span class="line">    ulint space;    <span class="comment">/*space id*/</span></span><br><span class="line">    ulint page_no;  <span class="comment">/*page number*/</span></span><br><span class="line">    unint n_bits;   <span class="comment">/*number of bits in the lock bitmap*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InnoDB中根据页的组织形式进行锁管理，并使用位图记录锁信息。<br>n_bits变量表示位图占用的字节数，它后面紧跟着一个bitmap，bitmap占用的字节为：1 + (nbits-1)/8，bitmap中的每一位标识对应的行记录是否加锁。<br>因此，lock_rec_struct占用的实际存储空间为：sizeof(lock_rec_struct) + 1 + (nbits-1)/8。</p>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/InnoDB%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/InnoDB%E7%89%B9%E6%80%A7/" class="post-title-link" itemprop="url">InnoDB特性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-24 11:23:43" itemprop="dateModified" datetime="2021-10-24T11:23:43+08:00">2021-10-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/InnoDB%E7%89%B9%E6%80%A7/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/InnoDB%E7%89%B9%E6%80%A7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Insert-Buffer-（不是缓存的一部分，而是物理页，是B-tree）"><a href="#Insert-Buffer-（不是缓存的一部分，而是物理页，是B-tree）" class="headerlink" title="Insert Buffer （不是缓存的一部分，而是物理页，是B+ tree）"></a>Insert Buffer （不是缓存的一部分，而是物理页，是B+ tree）</h3><h4 id="出现原因"><a href="#出现原因" class="headerlink" title="出现原因"></a>出现原因</h4><p>对于一般的只有一个主键并且该主键为递增的情况下，其插入聚集索引一般都是按照顺序的，不需要磁盘随机读取。但是对于有些情况下，一张表会有多个辅助索引，并且这些辅助索引不是==唯一==的，那么在进行插入操作的时候就需要离散的去访问这些非聚集索引页，那么整体的插入性能就会下降。</p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>对于非聚集索引的插入操作或者更新操作不是每一次都直接插入到对应的索引页中</p>
<p>先判断该非聚集索引页是否在缓冲池中，如果在则直接插入，如果不在则放入到一个Insert Buffer对象中，然后通过一定的频率和情况进行Insert Buffer与辅助索引子节点的合并操作</p>
<h4 id="Insert-Buffer生效场景"><a href="#Insert-Buffer生效场景" class="headerlink" title="Insert Buffer生效场景"></a>Insert Buffer生效场景</h4><p>必须要同时满足一下条件</p>
<ul>
<li><p>索引必须是辅助索引</p>
</li>
<li><p>索引不是唯一的</p>
<p>因为如果需要保证索引是唯一的话，那么需要在插入式数据库需要去查找索引页来判断插入记录的唯一性，这样和没有Insert Buffer是一样的，因此不能唯一</p>
</li>
</ul>
<h4 id="查看Insert-Buffer使用情况"><a href="#查看Insert-Buffer使用情况" class="headerlink" title="查看Insert Buffer使用情况"></a>查看Insert Buffer使用情况</h4><p><code>show engine innodb status\G</code></p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210716111822.png" alt="image-20210716111817369"></p>
<ul>
<li><p>free list 空闲列表长度</p>
</li>
<li><p>size 已经合并记录页的数量</p>
</li>
<li><p>inserts 插入记录</p>
</li>
<li><p>merged res 合并的插入记录数量</p>
</li>
<li><p>merges 合并的次数</p>
<p>该图中merges：merged res  = 1：3 表明插入缓冲对于非聚集索引页的离散IO逻辑请求降低了2/3</p>
</li>
</ul>
<h4 id="内部实现"><a href="#内部实现" class="headerlink" title="内部实现"></a>内部实现</h4><ul>
<li><p>全局只有一颗Insert Buffer B+ 树，负责对所有的表的副主索引进行Insert Buffer，存放于共享表空间中</p>
</li>
<li><p>非叶子节点存放查询的search key</p>
<table>
<thead>
<tr>
<th align="center">space</th>
<th align="center">marker</th>
<th align="center">offset</th>
</tr>
</thead>
</table>
<ul>
<li>Space 待插入记录所在表的表空间id</li>
<li>marker 兼容老版本Insert Buffer</li>
<li>offset 所在页的偏移量</li>
</ul>
</li>
<li><p>当一个副主索引要插入到页时，如果该页不在缓冲区中，那么构造一个search key，然后查询B+树，将该条记录插入到对应的Insert Buffer B+树的叶子节点中</p>
</li>
<li><p>叶子节点结构</p>
<table>
<thead>
<tr>
<th>space</th>
<th>marker</th>
<th>offset</th>
<th>metadata</th>
<th>secondary index record</th>
</tr>
</thead>
</table>
<p>metadata主要是负责记录每个record进入Insert Buffer的顺序</p>
</li>
<li><p>为了保证每次合并Insert Buffer都成功，需要用一个特殊的页来标记每个副主索引页的可用空间：Insert Buffer Bitmap</p>
<p>每个bitmap负责16384个辅助索引页，也就是256个区（每个区1M），每个bitmap位于这个256区中的第二页</p>
<p>每个辅助索引页在bitmap中占用4位</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210716115608.png" alt="image-20210716115537372"></p>
</li>
</ul>
<h4 id="Merge时机"><a href="#Merge时机" class="headerlink" title="Merge时机"></a>Merge时机</h4><ul>
<li><p>辅助索引页被读取到缓冲池中</p>
</li>
<li><p>Insert Buffer Bitmap页追踪到该辅助索引页已无可用空间</p>
<p>Insert Buffer Bitmap 页用来追踪每个辅助索引页的可用空间，并至少有1/32的空间。若插入辅助索引空间记录时检测到插入记录后可用的空间&lt;1/32页，会强制进行一个合并操作，即强制读取辅助索引页</p>
</li>
<li><p>Master Thread</p>
<p>每10s会进行一个Merge Insert Buffer的操作，每次merge的数量是不同的，她是随机选取Insert Buffer B+树中的一个页</p>
</li>
</ul>
<h4 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h4><p>默认情况下插入缓冲可以占到1/2的缓冲池内存</p>
<h4 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h4><ul>
<li>在写密集的场景下，插入缓冲会占用过多的缓冲池内存</li>
<li>当进行大量插入操作时，若mysql发生了宕机，势必有大量的Insert Buffer没有合并到时机的非聚集索引中区，从而导致恢复需要很长的时间</li>
</ul>
<h3 id="Change-Buffer"><a href="#Change-Buffer" class="headerlink" title="Change Buffer"></a>Change Buffer</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>Insert Buffer的升级，不光可以对Insert进行缓冲，还可以对delete、update进行缓冲</p>
<p><strong>总的来说，就是之前的Insert Buffer增加了对于delete还有update的功能，增加了几个新的Buffer（Delete Buffer、Purge Buffer）合称为Change Buffer</strong></p>
<h4 id="Change-Buffer生效场景"><a href="#Change-Buffer生效场景" class="headerlink" title="Change Buffer生效场景"></a>Change Buffer生效场景</h4><p>必须要同时满足一下条件</p>
<ul>
<li><p>索引必须是辅助索引</p>
</li>
<li><p>索引不是唯一的</p>
</li>
<li><p>change buffer的机制</p>
<p>在不影响数据一致性的前提下，InnoDB会将更新操作缓存在change buffer中，这样就不需要从磁盘中读入对应的数据页，在下次访问到这个数据页的时候将该数据叶读入内存，然后执行change buffer中与这个数据页的有关操作。</p>
<p><font color=red>注意: 如果将更新操作缓存到change buffer之后又立即对该数据页进行了访问，那么还是会触发随机读IO，将对应数据页加载到了缓存中，那么change buffer的作用也就很小</font></p>
</li>
</ul>
<h5 id="change-buffer不适用于唯一索引的原因"><a href="#change-buffer不适用于唯一索引的原因" class="headerlink" title="change buffer不适用于唯一索引的原因"></a>change buffer不适用于唯一索引的原因</h5><p>因为每次插入记录的时候需要检查该条记录的唯一性，会触发读取数据页，那么也就无法达到减少随机读IO的效果，也就导致change buffer失效</p>
<ul>
<li><p>chang buffer的使用场景</p>
<ul>
<li>写多读少的业务，页面在写完以后马上被访问的概率比较小，比如说账单类、日志类系统</li>
<li>如果所有的更新后面都马上伴随着对该记录的查询，那么应该关闭change buffer</li>
</ul>
</li>
<li><p>change buffe 更新案例</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904041433006093">https://juejin.cn/post/6844904041433006093</a></p>
</li>
</ul>
<h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><p>update的过程一般分为两个</p>
<ul>
<li>将记录标记为删除</li>
<li>真正将记录删除</li>
</ul>
<h5 id="Delete-buffer"><a href="#Delete-buffer" class="headerlink" title="Delete buffer"></a>Delete buffer</h5><p>对应update的第一个过程</p>
<h5 id="Purge-buffer"><a href="#Purge-buffer" class="headerlink" title="Purge buffer"></a>Purge buffer</h5><p>对应update的第二个过程</p>
<h4 id="相关参数-1"><a href="#相关参数-1" class="headerlink" title="相关参数"></a>相关参数</h4><ul>
<li><p><code>innodb_change_buffering</code></p>
<ul>
<li><p>inserts</p>
</li>
<li><p>deletes</p>
</li>
<li><p>puregs</p>
</li>
<li><p>changes </p>
<p>等于insert+deletes</p>
</li>
<li><p>all （默认）</p>
<p>等于insert+deletes+purges</p>
</li>
<li><p>none</p>
</li>
</ul>
</li>
<li><p><code>innodb_change_buffer_max_size</code></p>
<p>默认为25，即最多使用1/4的缓存池内存空间</p>
<p>最大值为50</p>
</li>
</ul>
<h3 id="两次写"><a href="#两次写" class="headerlink" title="两次写"></a>两次写</h3><h4 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h4><p>保证数据页的可靠性</p>
<h4 id="出现原因-1"><a href="#出现原因-1" class="headerlink" title="出现原因"></a>出现原因</h4><p>　一个数据页的大小是16K，假设在把内存中的脏页写到数据库的时候，写了2K突然掉电，也就是说前2K数据是新的，后14K是旧的，那么磁盘数据库这个数据页就是不完整的，是一个坏掉的数据页。redo只能加上旧、校检完整的数据页恢复一个脏块，不能修复坏掉的数据页，所以这个数据就丢失了，可能会造成数据不一致，所以需要double write。</p>
<h4 id="double-write组成"><a href="#double-write组成" class="headerlink" title="double write组成"></a>double write组成</h4><ul>
<li><p>doublewrite buffer （内存中）</p>
<p>大小为2M</p>
</li>
<li><p>物理磁盘上共享表中间的连续的128页</p>
<p>大小为2M</p>
</li>
</ul>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><ul>
<li>对缓冲池中的脏页进行刷新时<strong>不直接写磁盘</strong>，通过memcpy函数将脏页复制到内存中的double write buffer</li>
<li>buffer分两次（每次1M）将其写入到共享表空间的磁盘上 （顺序写，性能高）</li>
<li>立刻调用fsync函数，同步磁盘</li>
<li>在doublewrite页的写入完成后，再将double write buffer中的页写入到各个表空间文件中</li>
</ul>
<p>如果我们直接将其写入到磁盘的话，假如发生掉电，那么就会产生坏页</p>
<p>现在有了double write，假如发生掉电，对于原来的数据页是没有运行的，即使说在写入数据页的过程中发生了掉电，也可以从已经写好的double write中进行恢复数据页</p>
<h4 id="运行情况"><a href="#运行情况" class="headerlink" title="运行情况"></a>运行情况</h4><p><code>show global status like &#39;innodb_dblwr%&#39;\G</code></p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>如果本身文件系统就提供了写失效的防范机制，比如ZFS文件系统，在这种情况下用户就不需要启用doublewrite了。</p>
<h3 id="自适应哈希"><a href="#自适应哈希" class="headerlink" title="自适应哈希"></a>自适应哈希</h3><p>InnoDB会根据当前查询的情况自己建立hash索引</p>
<p>条件如下:</p>
<ul>
<li>对于某个页的连续访问模式必须是一样的，且访问了100次</li>
<li>对于某个页通过某一个模式访问了N次，N = 页中记录/16</li>
</ul>
<p>注意：hash索引只能查询等值条件</p>
<h3 id="异步IO"><a href="#异步IO" class="headerlink" title="异步IO"></a>异步IO</h3><ul>
<li><p>将多个IO合并为一个IO</p>
</li>
<li><p>不中断用户发送IO的请求</p>
</li>
</ul>
<p>在InnoDB中，read ahead的读取还有脏页的刷新都是AIO完成的</p>
<h3 id="刷新领接页"><a href="#刷新领接页" class="headerlink" title="刷新领接页"></a>刷新领接页</h3><p>刷新一个脏页时会检测该页所在区的所有页，如果是脏页也会一起进行刷新，可以将多个IO写入操作合并为一个IO操作</p>
<p>在机械磁盘下优势较大</p>
<h4 id="相关参数-2"><a href="#相关参数-2" class="headerlink" title="相关参数"></a>相关参数</h4><p>innodb_flush_neighbors</p>
<p>默认是开启的，如果固态硬盘有超高的IOPS，则建议将该参数设置为0，关闭此特性</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-23 09:01:40" itemprop="dateModified" datetime="2021-02-23T09:01:40+08:00">2021-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>reference（参考范围）一般和foreign key 一起使用</p>
<p>比如说当前有2个表，一为customer表，二为order表</p>
<p>为了确保所有的order都是来自于customer表中的名单，因此需要加上foreign key(customer_name) references customer(name)</p>
<p><font color=red> <strong>InnoDB仅当指定为单独的FOREIGN KEY规范的一部分时才接受REFERENCES子句。</strong></font></p>
</li>
<li><p>any 和 all 适用于子查询的场景  </p>
<p>any与all后面必须加上子查询的语句</p>
</li>
<li><p>exists</p>
<p>先进行外部父查询，然后针对父查询的结果集进行子查询，如子查询为true则输出，为false则放弃</p>
<p>一般来说not exists都要比not in效率高</p>
<p>exist和in比较如下：</p>
<p>所以如果父查询所查询的表中的数据越大那么 子查询查询的次数就会越多，这样对效率就很慢，</p>
<p><font color=red>子查询需要对父查询中的每一条记录进行查询判断</font></p>
<p>   例如:</p>
<p>​    <strong>1表a中100000条数据,表b中100条数据，查询数据库次数=1(表a查一次)+100000(子查询：查询表b的次数) ，一共</strong> <strong>100001次</strong></p>
<p>​     <strong>2 表a中 100条数据，表b100000条，查询数据库次数=1(表a查一次)+100(子查询次数)，一共 101次</strong></p>
<p>​     <strong>可见只有当子查询的表数量远远大于外部表数据的是否用exist查询效率好</strong></p>
</li>
<li><p>集合运算</p>
<ul>
<li><p>union和union all</p>
<p>UNION：将多个查询结果合并起来时，系统自动去掉重复元组<br>UNION ALL：将多个查询结果合并起来时，保留重复元组     </p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> Student <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">22</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> Student <span class="keyword">where</span> age<span class="operator">=</span><span class="number">22</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>INTERSECT 交集</li>
<li>EXCEPT差集</li>
</ul>
</li>
<li><p>约束条件</p>
<ul>
<li><p>CREATE TABLE时定义属性上的约束条件</p>
<ul>
<li>列值非空（NOT NULL）</li>
<li>列值唯一（UNIQUE）</li>
<li>检查列值是否满足一个条件表达式（CHECK）</li>
</ul>
</li>
<li><p>在CREATE TABLE时可以用CHECK短语定义元组上的约束条件，即元组级的限制<br>同属性值限制相比，元组级的限制可以设置不同属性之间的取值的相互约束条件 </p>
<p>例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Student</span><br><span class="line">         (  Sno    <span class="type">CHAR</span>(<span class="number">9</span>), </span><br><span class="line">            Sname  <span class="type">CHAR</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>，</span><br><span class="line">            Ssex    <span class="type">CHAR</span>(<span class="number">2</span>),</span><br><span class="line">            Sage   <span class="type">SMALLINT</span>,</span><br><span class="line">            Sdept  <span class="type">CHAR</span>(<span class="number">20</span>),</span><br><span class="line">            <span class="keyword">PRIMARY</span> KEY (Sno),</span><br><span class="line">            <span class="keyword">CHECK</span> (Ssex<span class="operator">=</span><span class="string">&#x27;女&#x27;</span> <span class="keyword">OR</span> Sname <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;Ms.%&#x27;</span>)</span><br><span class="line">            <span class="comment">/*定义了元组中Sname和 Ssex两个属性值之间的约束条件*/</span></span><br><span class="line">          );</span><br><span class="line"><span class="comment">/*性别是女性的元组都能通过该项检查，因为Ssex=‘女’成立;</span></span><br><span class="line"><span class="comment">当性别是男性时，要通过检查则名字一定不能以Ms.打头*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<ul>
<li><p>完整性约束命名子句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CONSTRAINT</span> <span class="operator">&lt;</span>完整性约束条件名<span class="operator">&gt;</span><span class="operator">&lt;</span>完整性约束条件<span class="operator">&gt;</span></span><br><span class="line"><span class="comment">-- &lt;完整性约束条件&gt;包括NOT NULL、UNIQUE、PRIMARY KEY短语、FOREIGN KEY短语、CHECK短语等</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 例如</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Student</span><br><span class="line">      (   Sno  <span class="type">NUMERIC</span>(<span class="number">6</span>)</span><br><span class="line">          <span class="keyword">CONSTRAINT</span> C1 <span class="keyword">CHECK</span> (Sno <span class="keyword">BETWEEN</span> <span class="number">90000</span> <span class="keyword">AND</span> <span class="number">99999</span>),</span><br><span class="line">          Sname  <span class="type">CHAR</span>(<span class="number">20</span>)  </span><br><span class="line">          <span class="keyword">CONSTRAINT</span> C2 <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">          Sage  <span class="type">NUMERIC</span>(<span class="number">3</span>)</span><br><span class="line">          <span class="keyword">CONSTRAINT</span> C3 <span class="keyword">CHECK</span> (Sage <span class="operator">&lt;</span> <span class="number">30</span>),</span><br><span class="line">          Ssex  <span class="type">CHAR</span>(<span class="number">2</span>)</span><br><span class="line">          <span class="keyword">CONSTRAINT</span> C4 <span class="keyword">CHECK</span> (Ssex <span class="keyword">IN</span> ( ‘男’,<span class="string">&#x27;女&#x27;</span>)),</span><br><span class="line">          <span class="keyword">CONSTRAINT</span> StudentKey <span class="keyword">PRIMARY</span> KEY(Sno)</span><br><span class="line">        );</span><br><span class="line"><span class="comment">-- 在Student表上建立了5个约束条件，包括主码约束（命名为StudentKey）以及C1、C2、C3、C4四个列级约束。</span></span><br></pre></td></tr></table></figure>

<p>最为主要的作用就是可以在任何时候使用<font color=red>删除</font>完整性约束命名子句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Student <span class="keyword">DROP</span> <span class="keyword">CONSTRAINT</span> C4;</span><br></pre></td></tr></table></figure>

<p>也可以<font color=red>增加</font>完整性约束命名子句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Student <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> C1 <span class="keyword">CHECK</span> (Sno <span class="keyword">BETWEEN</span> <span class="number">900000</span> <span class="keyword">AND</span> <span class="number">999999</span>),</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="6">
<li><p>实体完整性与参照完整性</p>
<ul>
<li><p>实体完整性 （主码）</p>
<ol>
<li><p>检查主码值是否唯一，如果不唯一则拒绝插入或修改 </p>
<p>两者方法：1.全表扫描 2.创建索引（B+树索引）</p>
</li>
<li><p>检查主码的各个属性是否为空，只要有一个为空就拒绝插入或修改</p>
</li>
</ol>
</li>
<li><p>参照完整性 （外码 foreign key与references配合使用）</p>
<p>违约处理：</p>
<ul>
<li>拒绝执行</li>
<li>级联操作</li>
<li>设置为空值</li>
</ul>
</li>
<li><p>用户定义完整性</p>
<p>违约处理</p>
<ul>
<li>不满足则操作拒绝执行</li>
</ul>
</li>
</ul>
</li>
<li><p>左右连接</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210223090129.png" alt="img"></p>
</li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">查询处理优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-13 08:26:30" itemprop="dateModified" datetime="2021-02-13T08:26:30+08:00">2021-02-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86%E4%BC%98%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86%E4%BC%98%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>498</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="查询处理步骤"><a href="#查询处理步骤" class="headerlink" title="查询处理步骤"></a>查询处理步骤</h2><ol>
<li><p>语法分析和翻译</p>
<p>主要是语法与权限检查以及将SQL语句转化为等价的内部表示形式</p>
</li>
<li><p>优化</p>
<p>选择高效执行的查询执行计划</p>
</li>
<li><p>执行</p>
</li>
</ol>
<h2 id="查询树的表示"><a href="#查询树的表示" class="headerlink" title="查询树的表示"></a>查询树的表示</h2><h3 id="最初语法树"><a href="#最初语法树" class="headerlink" title="最初语法树"></a>最初语法树</h3><p><font color=red>最重要的一点就是自下而上写</font></p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210104151854521.png" alt="image-20210104151854521" style="zoom:50%;" />

<p>几个名词：</p>
<ul>
<li>投影：project</li>
<li>选择：select</li>
<li>连接：join</li>
</ul>
<h3 id="关系代数语法树"><a href="#关系代数语法树" class="headerlink" title="关系代数语法树"></a>关系代数语法树</h3><p>​    <img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210104152133295.png" alt="image-20210104152133295" style="zoom:50%;" /></p>
<h3 id="优化查询树"><a href="#优化查询树" class="headerlink" title="优化查询树"></a>优化查询树</h3><p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210104152917.png" alt="image-20210104152916371"></p>
<h2 id="查询树的启发式优化"><a href="#查询树的启发式优化" class="headerlink" title="查询树的启发式优化"></a>查询树的启发式优化</h2><ul>
<li><p><font color=red>选择运算应尽可能先做</font><br>在优化策略中这是最重要、最基本的一条。</p>
</li>
<li><p>把投影运算和选择运算同时进行<br>如有若干投影和选择运算，并且它们都对同一个关系操作，则可以在扫描此关系的同时完成所有的这些运算以避免重复扫描关系。</p>
</li>
<li><p>把投影同其前或其后的双目运算结合起来，没有必要为了去掉某些字段而扫描一遍关系。</p>
</li>
<li><p>把某些选择同在它前面要执行的笛卡尔积结合起来成为一个连接运算，连接特别是等值连接运算要比同样关系上的笛卡尔积省很多时间。</p>
</li>
<li><p>找出公共子表达式<br>如果这种重复出现的子表达式的结果不是很大的关系并且从外存中读入这个关系比计算该子表达式的时间少得多，则先计算一次公共子表达式并把结果写入中间文件是合算的。<br>当查询的是视图时，定义视图的表达式就是公共子表达式的情况</p>
</li>
</ul>
<p>  <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18E41137Cm?from=search&seid=6874889460109418968">参考</a></p>
<h2 id="物理优化"><a href="#物理优化" class="headerlink" title="物理优化"></a>物理优化</h2><ol>
<li><p>基于启发式规则的存取路径选择优化</p>
<ul>
<li>选择操作的启发式规则</li>
<li>连接操作的启发式规则</li>
</ul>
</li>
<li><p>基于代价的优化</p>
</li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/MyCat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/MyCat/" class="post-title-link" itemprop="url">MyCat</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:40:03" itemprop="dateModified" datetime="2021-08-27T22:40:03+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyCat/" itemprop="url" rel="index"><span itemprop="name">MyCat</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/MyCat/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/MyCat/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="mycat安装"><a href="#mycat安装" class="headerlink" title="mycat安装"></a>mycat安装</h4><p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/Conquer-Linux/Linux-Tutorial-Mycat-Install-And-Settings.md">参考</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-download/tree/master/1.6-RELEASE">Mycat下载</a></p>
<h4 id="初始化mycat"><a href="#初始化mycat" class="headerlink" title="初始化mycat"></a>初始化mycat</h4><p>server.xml中主要是设置mycat的账户密码（就和数据库操作的账户密码一样）以及其他的一些信息</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210324102330.png" alt="image-20210324102329485"></p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210324102333.png" alt="image-20210323214823933"></p>
<h5 id="schema-xml模板"><a href="#schema-xml模板" class="headerlink" title="schema.xml模板"></a>schema.xml模板</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;share&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1 &quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;172.23.27.118:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                                   <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- can have multi read hosts --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;172.23.27.119:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="分表"><a href="#分表" class="headerlink" title="分表"></a>分表</h4><ol>
<li><p>针对不同的table设置不同的DataNode</p>
<p>记得要在Mycat上对表进行创建，因为正是mycat对其做的拦截操作</p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210324102029.png" alt="image-20210324102027262" style="zoom:50%;" />



<h4 id="针对表设置rule"><a href="#针对表设置rule" class="headerlink" title="针对表设置rule"></a>针对表设置rule</h4><ol>
<li>schema.xml中设置rule的id</li>
<li>在rule.xml中针对1中的id进行设置</li>
</ol>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210324102055.png" alt="image-20210323220918501" style="zoom:50%;" />
      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E7%BB%8F%E5%85%B8SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E7%BB%8F%E5%85%B8SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5/" class="post-title-link" itemprop="url">经典SQL查询语句</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-13 08:26:57" itemprop="dateModified" datetime="2021-02-13T08:26:57+08:00">2021-02-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E7%BB%8F%E5%85%B8SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E7%BB%8F%E5%85%B8SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="查询不重复"><a href="#查询不重复" class="headerlink" title="查询不重复"></a>查询不重复</h4><p>select distinct Depart from teacher;</p>
<h4 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h4><p>select * from Score where Degree in (85,86,88);</p>
<h4 id="按照顺序查询"><a href="#按照顺序查询" class="headerlink" title="按照顺序查询"></a>按照顺序查询</h4><p>select * from Score order by Cno asc,Degree desc;  (sql默认是升序)</p>
<h4 id="查询Score表中的最高分的学生学号和课程号。（子查询或者排序）"><a href="#查询Score表中的最高分的学生学号和课程号。（子查询或者排序）" class="headerlink" title="查询Score表中的最高分的学生学号和课程号。（子查询或者排序）"></a>查询Score表中的最高分的学生学号和课程号。（子查询或者排序）</h4><p>select Sno,Cno from Score where Degree = ( select max(Degree) from Score); </p>
<p>or</p>
<p>select Sno,Cno from Score order by Degree desc limit 0,1;</p>
<h4 id="查询分数大于70，小于90的Sno列"><a href="#查询分数大于70，小于90的Sno列" class="headerlink" title="查询分数大于70，小于90的Sno列"></a>查询分数大于70，小于90的Sno列</h4><p>此处需要与上面的区间比较：这里不是标准的区间，而是&gt;70 and &lt;90，因此需要写成</p>
<p>select Sno from Score where Degree &gt;70 and Degree &lt; 90;</p>
<h4 id="多表连接"><a href="#多表连接" class="headerlink" title="多表连接"></a>多表连接</h4><ul>
<li><p>内连接 inner join</p>
<p>select Sname,Cno,Degree from Student inner join Score on Student.Sno=Score.Sno;</p>
<p>select Sname,Cname,Degree from Student inner join Score on Student.Sno=Score.Sno inner join  Course on Score.Cno=Course.Cno;</p>
</li>
<li><p>外连接 left join</p>
<p>select Sname,Cno,Degree from Student left join Score on Student.Sno=Score.Sno;</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tinyj/p/10035143.html">外连接与内连接的区别在于</a></p>
</li>
<li><p>where</p>
<p>select Sname,Cno,Degree from Student,Score where Student.Sno=Score.Sno;</p>
<p>select Sname,Cname,Degree from student,course,score where student.Sno=score.Sno and course.Cno=score.Cno;</p>
</li>
</ul>
<h4 id="查询成绩比该课程平均成绩低的同学的成绩表"><a href="#查询成绩比该课程平均成绩低的同学的成绩表" class="headerlink" title="查询成绩比该课程平均成绩低的同学的成绩表"></a>查询成绩比该课程平均成绩低的同学的成绩表</h4><p>select * from score a  where degree &lt; ( select avg(degree) from score b where b.cno=a.cno);</p>
<h4 id="查询所有任课教师的Tname和Depart"><a href="#查询所有任课教师的Tname和Depart" class="headerlink" title="查询所有任课教师的Tname和Depart"></a>查询所有任课教师的Tname和Depart</h4><p>select Tname,Depart from Teacher where Tno in ( select Tno from Course);</p>
<h4 id="查询所有未讲课的教师的Tname和Depart"><a href="#查询所有未讲课的教师的Tname和Depart" class="headerlink" title="查询所有未讲课的教师的Tname和Depart"></a>查询所有未讲课的教师的Tname和Depart</h4><p>select Tname,Depart from Teacher where Tno not in ( select Tno from Course where Cno in ( select Cno from Score ));</p>
<h4 id="查询至少有2名男生的班号"><a href="#查询至少有2名男生的班号" class="headerlink" title="查询至少有2名男生的班号"></a>查询至少有2名男生的班号</h4><p>select Class from Student where Ssex = ‘男’ group by Class  having count(Ssex) &gt;1;</p>
<h4 id="查询Student表中每个学生的姓名和年龄"><a href="#查询Student表中每个学生的姓名和年龄" class="headerlink" title="查询Student表中每个学生的姓名和年龄"></a>查询Student表中每个学生的姓名和年龄</h4><p>select Sname,year(now())-year(Sbirthday) from Student;</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/35/">35</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cooper</p>
  <div class="site-description" itemprop="description">记录一些学习笔记、小说、随笔</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">341</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/CooperXJ" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CooperXJ" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1789023580@qq.com" title="E-Mail → mailto:1789023580@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cooper</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">648k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:49</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'rOzi1T6uncSYNdx0tp1owOzV-gzGzoHsz',
      appKey     : 'Fk3s6CQBK042e1QltClHnTBP',
      placeholder: "留下邮箱，有回复时你将收到提醒，邮箱不会被公开",
      avatar     : 'wavatar',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
