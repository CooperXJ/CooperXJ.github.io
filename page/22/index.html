<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cooperxj.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="记录一些学习笔记、小说、随笔">
<meta property="og:type" content="website">
<meta property="og:title" content="Cooper Notes">
<meta property="og:url" content="http://cooperxj.github.io/page/22/index.html">
<meta property="og:site_name" content="Cooper Notes">
<meta property="og:description" content="记录一些学习笔记、小说、随笔">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Cooper">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://cooperxj.github.io/page/22/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Cooper Notes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Cooper Notes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">obey rules</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/MySQL%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/MySQL%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">MySQL基础知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:41:19" itemprop="dateModified" datetime="2021-08-27T22:41:19+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/MySQL%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/MySQL%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>153</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="几个名词定义"><a href="#几个名词定义" class="headerlink" title="几个名词定义"></a>几个名词定义</h4><ul>
<li><p>数据库</p>
<p>物理操作系统文件或者其他形式文件的集合</p>
</li>
<li><p>实例</p>
<p>真正操作数据库的应用进程</p>
</li>
<li><p>mysql多实例</p>
<p>就是在一台服务器上开始多个MySQL服务实例</p>
</li>
</ul>
<h4 id="整体表现形式"><a href="#整体表现形式" class="headerlink" title="整体表现形式"></a>整体表现形式</h4><p>单进程多线程的应用</p>
<h3 id="mysql的连接方式"><a href="#mysql的连接方式" class="headerlink" title="mysql的连接方式"></a>mysql的连接方式</h3><ul>
<li><p>TCP/IP</p>
</li>
<li><p>命名管道</p>
</li>
<li><p>共享内存</p>
</li>
<li><p>unix域套接字</p>
<p><code>mysql -u root -p -S &#123;sock的路径&#125;</code></p>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/MySQL%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/MySQL%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">MySQL安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-17 22:11:24" itemprop="dateModified" datetime="2021-02-17T22:11:24+08:00">2021-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/MySQL%E5%AE%89%E8%A3%85/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/MySQL%E5%AE%89%E8%A3%85/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>739</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>GA版为稳定版本</li>
<li>Bit版为尝鲜版</li>
</ul>
<ol>
<li><p>下载mysql repo源</p>
<ul>
<li><p>先检查是否已经安装mysql</p>
<p>rpm -qa | grep mysql</p>
</li>
<li><p>下载mysql的repo源</p>
<p>wget <a target="_blank" rel="noopener" href="http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm">http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</a></p>
</li>
<li><p>安装</p>
<p>sudo rpm -ivh mysql-community-release-el7-5.noarch.rpm</p>
</li>
</ul>
</li>
<li><p>下载安装mysql</p>
<p><code>sudo yum install mysql-server</code></p>
</li>
<li><p>查看linux用户以及用户组</p>
<p>cat /etc/passwd|grep mysql</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210217204420096.png" alt="image-20210217204420096" style="zoom:50%;" />

<p>cat /etc/group|grep mysql</p>
</li>
<li><p>开启mysql</p>
<p><code>service mysql start</code></p>
</li>
<li><p>设置mysql密码</p>
<p><code>/usr/bin/mysqladmin -u root password 123456</code></p>
</li>
<li><p>设置mysql自启动</p>
<p><code>chkconfig mysql on</code></p>
<p>界面显示启动项</p>
<p><code>ntsysv</code></p>
</li>
<li><p>设置字符集</p>
<p>原始的字符集查询情况如下：</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210217212017370.png" alt="image-20210217212017370" style="zoom:50%;" />

<p>可以看到有些字符集为latin1，这样的话出现中文就会出现乱码</p>
<p>因此需要进行修改my.cnf</p>
<p>在mysqld中加上这两句话</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210217213212550.png" alt="image-20210217213212550" style="zoom:50%;" />

<p>最终结果为</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210217213122.png" alt="image-20210217213117464" style="zoom:50%;" />

<p>注意：</p>
<ul>
<li><p>如果在设置uft8字符集之前已经创建了库，那么整个库里面的表都不会使用utf8字符集</p>
</li>
<li><p>如果想不修改配置文件，但是要使用utf8就需要在建库的时候声明字符集</p>
<p><code>create database if not exists test03 default character set = &#39;utf8&#39;;</code></p>
</li>
</ul>
</li>
</ol>
<h3 id="相关信息"><a href="#相关信息" class="headerlink" title="相关信息"></a>相关信息</h3><ul>
<li><p>mysql创建的各个文件夹的作用</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210217210544.png" alt="image-20210217210539977" style="zoom:50%;" /></li>
<li><p>mysql的配置文件一般就是/etc/my.cnf</p>
<p>一般安装好mysql之后就会自动从/usr/share/mysql/my-default.cnf拷贝到/etc目录下，名字为my.cnf</p>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E8%A1%A8/" class="post-title-link" itemprop="url">表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:37:51" itemprop="dateModified" datetime="2021-08-27T22:37:51+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E8%A1%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E8%A1%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="索引组织表"><a href="#索引组织表" class="headerlink" title="索引组织表"></a>索引组织表</h4><ul>
<li><p>定义</p>
<p>表根据主键顺序组织存放</p>
</li>
<li><p>主键的选择与创建</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210729105959.png" alt="image-20210729105957948"></p>
</li>
</ul>
<h4 id="InnoDB逻辑存储结构"><a href="#InnoDB逻辑存储结构" class="headerlink" title="InnoDB逻辑存储结构"></a>InnoDB逻辑存储结构</h4><ul>
<li><p>表空间</p>
<ul>
<li><p>共享表空间</p>
<p>回滚信息、插入缓冲索引页、系统事务信息、二次写缓存等</p>
</li>
<li><p>单独表空间 （如果不开启则所有的数据都会存放到共享表空间中，默认是开启的）</p>
<p>对应的参数为innodb_file_per_table</p>
<p>数据、索引和插入缓冲Bitmap页</p>
</li>
</ul>
</li>
<li><p>组成</p>
<ul>
<li>段<ul>
<li>表空间是由段组成的</li>
<li>数据段为B+树叶子节点</li>
<li>索引段为B+树非叶子节点</li>
<li>段由区组成</li>
</ul>
</li>
<li>区<ul>
<li>区是由连续页组成的空间，区的大小为1M</li>
<li>为了保证连续性，InnoDB一次从磁盘中申请4~5个区</li>
<li>默认情况下一个区（1M）有64页（16K）</li>
</ul>
</li>
<li>页<ul>
<li>页的大小默认为16K，可以通过参数innodb_page_size修改</li>
</ul>
</li>
</ul>
</li>
<li><p>单独表空间申请空间流程</p>
<ul>
<li>创建的表默认为96K</li>
<li><font color=red>每个段</font>开始时使用32个页大小的碎片页存放数据，比如数据段使用了32个碎片页了，那么下一次申请就会直接申请一个区，索引段使用了32个碎片页了，那么下一次申请就会是一个区</li>
<li>碎片页使用完之后才是64个连续页的申请，也就是采用区的方式进行空间申请</li>
</ul>
<p>好处:节省空间</p>
</li>
<li><p>行</p>
<p>InnoDB每页最多存放16K/2 - 200行记录</p>
<p>/2是因为每个记录至少包含2个字节</p>
<p>200是为系统预留的</p>
</li>
</ul>
<h4 id="InnoDB行记录格式"><a href="#InnoDB行记录格式" class="headerlink" title="InnoDB行记录格式"></a>InnoDB行记录格式</h4><ul>
<li><p>查看表的格式</p>
<p><code>show table status like &#39;&#123;表名&#125;&#39;</code></p>
</li>
<li><p>行记录采用单链表的方式组成页</p>
</li>
</ul>
<h5 id="Compact"><a href="#Compact" class="headerlink" title="Compact"></a>Compact</h5><ul>
<li><p>格式</p>
<table>
<thead>
<tr>
<th>变长字段长度列表</th>
<th>NULL标志位</th>
<th>记录头信息</th>
<th>列1数据</th>
<th>列2数据</th>
<th>….</th>
</tr>
</thead>
</table>
<ul>
<li><p>变长字段长度列表 （<font color=red>注意是变长字段，像char这种定长字段是不在这里显示的</font>）</p>
<p>按照列的顺序逆序放置，长度为</p>
<ul>
<li>若列长度&lt;255 使用1字节表示</li>
<li>若长度&gt;255 使用2字节表示 （暗示varchar最长不能超过2^16-1）</li>
</ul>
</li>
<li><p>NULL标志位 （1字节）</p>
<p>该位表示该行数据中是否含有NULL值，有则使用1表示</p>
<p>例如该标志位的值是06，转为二进制表示为0000 0110，则代表第三列和第二列为NULL（为1）</p>
<p>NULL标志位：NULL标志位可以看作是NULL值列表，在表中的某些列中是可能存储NULL值的，如果把这些NULL值放到记录的真实数据中存储是很占用空间的，所以MySQL中Compact行格式会把这些列值为NULL的列统一进行管理并存储到NULL值列表中和变长字段长度列表一样它也是<strong>逆序存储</strong>的NULL值列表的存储不占用真实存储空间只占用NULL值列表，如果<strong>当前列为NULL值则用二进位1表示，当前列不为NULL值则用二进制位0表示，</strong>如果当前行中所有列都为NOT NULL则不会分配NULL列表的存储空间，在实际开发中创建表时都会设置为NOT NULL因为这样可以节省空间、提高整体的效率</p>
</li>
<li><p>记录头信息 （5字节）</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210730110653.png" alt="image-20210730110651436"></p>
</li>
<li><p><font color=red>对于varchar与char中的NULL值都不会占用空间</font></p>
</li>
<li><p>当char字段未能完全占用其长度空间时，会用0x20进行填充</p>
</li>
<li><p>每行存在两个隐藏列</p>
<ul>
<li>transactionID</li>
<li>Roll Pointer</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Redundant"><a href="#Redundant" class="headerlink" title="Redundant"></a>Redundant</h5><ul>
<li><p>格式</p>
<table>
<thead>
<tr>
<th>字段长度偏移列表</th>
<th>记录头信息</th>
<th>列1数据</th>
<th>列2数据</th>
<th>….</th>
</tr>
</thead>
</table>
</li>
<li><p>字段长度偏移列表</p>
<p>按照列的顺序逆序放置的，其中有三个隐藏列</p>
</li>
<li><p>记录头信息 （48位）</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210730112024.png" alt="image-20210730112019701"></p>
<ul>
<li><p>n_fields</p>
<p>表示当前列中的数量，一共有10位，也就代表一行最多有1023列</p>
</li>
<li><p><font color=red>对于varchar中的NULL值不会占用空间，对于char中的NULL值会占用空间</font></p>
</li>
<li><p>每行存在三个隐藏列</p>
</li>
</ul>
</li>
</ul>
<h4 id="行溢出数据"><a href="#行溢出数据" class="headerlink" title="行溢出数据"></a>行溢出数据</h4><ul>
<li><p>定义</p>
<p>InnoDB存储引擎会将一些记录中的数据存储在真正的页面之外</p>
<p>这其中包括了BLOB、LOB甚至varchar也有可能</p>
</li>
<li><p>varchar的最长存储长度为65535（单位为字节），但是实际建表的时候最多只能达到65532，因为还有一些别的开销</p>
<p>除此之外65535指的是所有列中varchar类型的长度总和</p>
</li>
<li><p>如果一个页面无法存下两条行记录，那么InnoDB引擎会自动将行数据存放到溢出页中，经过测试varchar类型存放到溢出页的阈值为0898，也就是当长度为8098的时候，一个页可以存下两条行记录，但是一旦超过该数值，则会存放到BLOB页上</p>
</li>
<li><p>不同行记录格式对于行溢出数据的影响</p>
<ul>
<li><p>redundant或compact</p>
<p><strong>如果blob列值长度</strong> <strong>&lt;= 768 bytes，不会发生行溢出(page overflow)，内容都在数据页(B-tree Node)；如果列值长度** **&gt; 768字节，那么前768字节依然在数据页，而剩余的则放在溢出页(off-page)，如下图：</strong></p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210803142442.png" alt="3629077771-5c244c8393a92_articlex.png"></p>
</li>
<li><p>compressed或dynamic</p>
<p><strong>对blob采用完全行溢出，即聚集索引记录（数据页）只保留20字节的指针，指向真实存放它的溢出段地址：</strong></p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210803142542.png" alt="3507325740-5c244c83a06bf_articlex.png"></p>
<p>其中compressed行记录格式可以将存储在其中的行数据以zlib算法进行压缩</p>
</li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/DataArt/p/10223567.html">参考</a></p>
</li>
</ul>
<h4 id="char的行结构存储"><a href="#char的行结构存储" class="headerlink" title="char的行结构存储"></a>char的行结构存储</h4><ul>
<li>对于多字节编码（比如GBK、UTF-8）的char数据类型的存储，InnoDB在内部会将其视为变长字符类型，但是对于未能占满长度的字符还是填充0x20</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/InnoDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/InnoDB/" class="post-title-link" itemprop="url">InnoDB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:39:07" itemprop="dateModified" datetime="2021-08-27T22:39:07+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/InnoDB/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/InnoDB/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="InnoDB体系架构"><a href="#InnoDB体系架构" class="headerlink" title="InnoDB体系架构"></a>InnoDB体系架构</h3><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210713093309.png" alt="image-20210713093304615" style="zoom:50%;" />

<p>后台线程的作用</p>
<ul>
<li>负责刷新内存池中的数据，保存缓冲池中的内存缓存是最近的数据</li>
<li>将已经修改 大数据文件刷新到磁盘文件</li>
<li>保证数据库发生异常能够恢复</li>
</ul>
<h4 id="后台线程类型"><a href="#后台线程类型" class="headerlink" title="后台线程类型"></a>后台线程类型</h4><ul>
<li><p>Master Thread （核心线程）</p>
<p>==作用==</p>
<ul>
<li>将缓冲池中的数据异步刷新到磁盘，保证数据一致性</li>
</ul>
<p><strong>Matser Thread优先级是最高的</strong></p>
<p>==组成：==</p>
<ul>
<li><p>主循环 loop （主要状态）</p>
<ul>
<li><p>每秒操作</p>
<ul>
<li><p>日志缓冲刷新到磁盘，即使没有提交 （总是）</p>
</li>
<li><p>合并缓冲 （可能）</p>
<p>当前一秒内IO操作次数&lt;5 执行该操作</p>
</li>
<li><p>至多刷新100个InnoDB的缓冲池中的脏页到磁盘 （可能）</p>
<p>当前缓冲池中的脏页比例&gt;对应参数innodb_max_dirty_pages_pct 执行该操作</p>
</li>
<li><p>如果没有当前用户活动，切换至backgroup loop （可能）</p>
</li>
</ul>
</li>
<li><p>每10s操作</p>
<ul>
<li><p>刷新100个脏页到磁盘（可能）</p>
<p>当前10s内IO次数&lt;200 执行该操作</p>
</li>
<li><p>合并至多5个插入缓冲区（总是）</p>
</li>
<li><p>将日志缓冲刷新到磁盘（总是）</p>
</li>
<li><p>删除无用的Undo页（总是）</p>
<p>full page操作</p>
<p>最多尝试回收20个undo页</p>
</li>
<li><p>刷新100个或者10个脏页到磁盘（总是）</p>
<p>脏页比例&gt;70% 刷新100个到磁盘</p>
<p>脏页比例&lt;70% 刷新10个到磁盘</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>后台循环 backgroup loop</p>
<ul>
<li>删除无用的undo页（总是）</li>
<li>合并20个插入缓冲区 （总是）</li>
<li>跳回到主循环（总是）</li>
<li>不断刷新100个页直到符合条件 （可能跳转到flush loop中完成）</li>
</ul>
</li>
<li><p>刷新循环 flush loop</p>
</li>
<li><p>暂停循环 suspend loop</p>
</li>
</ul>
<p>==切换状态==</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210715095737.png" alt="image-20210715095730533"></p>
<p>==Master Thread的更新==</p>
<ul>
<li><p>添加了可以自定义的数值Innodb_io_capacity</p>
<ul>
<li>在合并插入缓冲时（insert buffer），合并插入缓冲的数量为innodb_io_capacity的5%</li>
<li>从缓冲区刷新脏页时，刷新脏页的数量为innodb_io_capacity</li>
</ul>
</li>
<li><p>添加了innodb_adaptive_flushing参数</p>
<p>该参数开启之后可以通过一个函数来判断需要刷新脏页最合适的数量，相当于一个自适应的参数开启，而不是靠原来innodb_max_dirty_pages_pct的参数决定刷新脏页的数量</p>
<p>该函数是通过判断重做日志的速度来决定最适合的刷新脏页的数量</p>
<p><strong>注意：开启该参数之后当脏页比例小于innodb_max_dirty_pages_pct的时候也会刷新一定量的脏页</strong></p>
</li>
<li><p>添加了参数innodb_purge_batch_size</p>
<p>可以通过修改该参数控制full purge时回收Undo页的数量</p>
</li>
<li><p>刷新脏页的操作从master thread分离到一个单独的page cleaner thread</p>
</li>
</ul>
<p>==查看系统的负载==</p>
<p>可以通过<code>show engine innodb status\G </code>中的srv_main_thread loop中的1_seconds和sleeps中的差值来反映当前数据库的负载压力</p>
</li>
<li><p>IO Thread</p>
<ul>
<li><p>作用：</p>
<ul>
<li>负责IO请求的回调</li>
</ul>
</li>
<li><p>IO种类：</p>
<ul>
<li>read</li>
<li>write</li>
<li>insert buffer</li>
<li>log IO thread</li>
</ul>
<p><strong>注意：在MySQL5.1.X之前linux下IO Thread数量不能调整，但是现在版本在linux上可以根据CPU核心数进行调整，之前和现在的在windows平台下可以调整</strong></p>
<p>现在版本的InnoDB中的read和write已经分别增大到了4个</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40901788/article/details/84969375">IO Thread的个数参考</a></p>
</li>
<li><p>相关命令</p>
<ul>
<li><p>查看InnoDB版本</p>
<p><code>show variables like &#39;innodb_version&#39;\G</code></p>
</li>
<li><p>查看read和write线程数量</p>
<p><code>show variables like &#39;innodb_%io_threads&#39;\G</code></p>
</li>
<li><p>查看当前各个线程状态</p>
<p><code>show engine innodb status\G</code></p>
<p>可以看到总的线程状态为：</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210713094949.png" alt="image-20210713094947694"></p>
<p>其中insert buffer thread数量为1，log thread数量为1，read和write分别为4</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Purge Thread</p>
<p>事物被提交之后其所使用过的undolog可能不再需要，因此需要PurgeThread来回收已经使用并分配到undo页</p>
<p>之前的版本purge操作都是在master thread中完成的，从1.1版本开始purge thread可以独立到单独的线程中进行 </p>
<ul>
<li><p>如何启用独立的purge thread？</p>
<p>在配置文件中添加如下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">innodb_purge_threads = 1 #1.1版本只能有1个，之后版本可以设置为多个</span><br></pre></td></tr></table></figure></li>
<li><p>查看purge thread数量</p>
<p><code> show variables like &#39;innodb_purge_threads&#39;\G</code></p>
</li>
</ul>
</li>
<li><p>Page Cleaner Thread</p>
<ul>
<li><p>作用</p>
<p>将之前版本中的脏页的刷新操作放入到单独的线程中完成</p>
</li>
</ul>
</li>
</ul>
<h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4><ul>
<li><p>页从缓冲区刷新回磁盘的操作并不是每次页发生变更时触发的，而是通过一种成为Checkpoint的机制刷新回磁盘</p>
</li>
<li><p>内存结构</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210713104018.png" alt="image-20210713104013265" style="zoom:50%;" /></li>
<li><p>缓冲池相关指令</p>
<ul>
<li><p>查看缓冲池大小 (单位为字节，除以三个1024单位为G)</p>
<p><code>show variables like &#39;innodb_buffer_pool_size&#39;\G</code></p>
</li>
</ul>
</li>
<li><p>缓冲池实例</p>
<p>InnoDB允许有多个缓冲池实例，每个页根据哈希值平均分配到不同的缓冲池实例中，这样可以减少数据库内部资源竞争，增加数据库的并发</p>
<ul>
<li><p>缓冲池实例指令</p>
<ul>
<li><p>查看缓冲池实例个数</p>
<p><code>show variables like &#39;innodb_buffer_pool_instances&#39;\G</code></p>
</li>
<li><p>查看每个缓冲池的状态</p>
<p><code>show engine innodb status\G</code></p>
<p>在INDIVIDUAL BUFFER POOL INFO标签下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use information_schema;</span><br><span class="line">select pool_id,pool_size,free_buffers,database_pages from INNODB_BUFFER_POOL_STATS\G</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>缓冲池配置注意事项</p>
<p>要启用多个缓冲池实例，请将innodb_buffer_pool_instances配置选项设置为 大于1(默认)的值，最大为64(最大)。仅当您将innodb_buffer_pool_size大小设置为1GB或更大时，此选项才生效 。您指定的总大小将分配给所有缓冲池。为了获得最佳效率，指定的组合 innodb_buffer_pool_instances 和innodb_buffer_pool_size，使得每个缓冲池实例是至少为1GB。</p>
</li>
</ul>
</li>
<li><p>LRU List</p>
<ul>
<li><p>缓冲区的管理策略为LRU：频繁使用的页放在前端，最少使用的页放在后端</p>
</li>
<li><p>默认缓冲区中的每页大小为16K</p>
</li>
<li><p>LRU的优化</p>
<p>新加入的页面不是立刻放入LRU页表的首部，而是放在LRU列表的midpoint位置</p>
<p>该位置查询指令</p>
<p><code>show variables like &#39;innodb_old_blocks_pct&#39;\G</code></p>
<p>指的是距离LTU列表尾端多少的百分比</p>
<p>在 midpoint之前的为new表，之后的为old表</p>
<p>优化的原因：</p>
<p>因为有些操作需要表中的许多数据，比如说是索引，数据扫描（select * ）操作只是在一次操作中使用到，但并非是真正的热点操作。</p>
</li>
<li><p>相关参数</p>
<ul>
<li><p>innodb_old_blocks_pct</p>
<p>可以看到，参数innodb_old_blocks_pct 默认值是37，表示新读取的页插入到LRU列表尾端的37%的位置（差不多3/8的位置）。在innodb存储引擎中，把midpoint之后的列表称为old列表，之前的列表称为new列表。可以简单理解为new列表中的页都是最为活跃的热点数据。</p>
<p>innodb的37%的空间是可以让人来刷的。（意思就是内存的37%拿出来让人刷，就是冷数据区的大小）；<br>建议innodb_old_blocks_pct 调成20%（调整内存参数）：</p>
<p><code>set global innodb_old_blocks_pct = 20;</code></p>
<p>即，一个64G的物理内存，80%给数据库，数据库的80%给热数据区，即40.96G给了热数据区。</p>
</li>
</ul>
<ul>
<li><p>innodb_old_blocks_time</p>
<p>这个参数用来表示 页读取到mid位置后，需要等待多久才会被加入到LRU列表的热端。<br>使LRU列表中的热点数据不被刷出：</p>
<p><code>set global innodb_old_blocks_time=1000；</code></p>
<p>放在冷热数据交界处，默认1000ms，过了这1s，还能存活下去，就调到热数据区了。</p>
</li>
</ul>
</li>
<li><p>查看当前LRU列表情况</p>
<p>命令</p>
<p><code>show engine innodb status\G</code></p>
<ul>
<li><p>free buffers</p>
<p>当前free列表中页的数量</p>
</li>
<li><p>database pages</p>
<p>LRU列表中的数量</p>
<p>注意：有可能free buffers+database pages!=buffer pool size,因为有可能页会被分配给自适应哈希索引，Lock信息，Insert Buffer等页</p>
</li>
<li><p>pages made young</p>
<p>LRU列表中页移动到前端的次数</p>
</li>
<li><p>buffer pool hit rate</p>
<p>缓冲池的命中率 如果&lt;95%则效果不太好，正常都是&gt;95%</p>
</li>
<li><p>查看每个LRU列表中的每个页的具体信息</p>
<p><code>select table_name,space,page_number,page_type from INNODB_BUFFER_PAGE_LRU where space = 1;</code></p>
</li>
</ul>
</li>
<li><p>LRU列表中的压缩页</p>
<p>支持压缩页的功能，将原来的16K压缩为1K，2K，4K和8K</p>
<p>对于非16K的页是通过unzip_LRU进行管理的</p>
<p>这些压缩页的分配策略是伙伴算法</p>
<p>查看压缩页指令</p>
<p><code>select table_name,space,page_number,compresed_size from INNODB_BUFFER_PAGE_LRU where compresed_size != 0;</code></p>
</li>
<li><p>LRU表中的脏页</p>
<ul>
<li><p>定义</p>
<p>当LRU表中页被修改了之后成为脏页，数据库会在checkpoint时机将其刷新回磁盘</p>
</li>
<li><p>脏页所在地点</p>
<p>flush list中的页就是脏页列表</p>
<p>脏页不仅存在于flush list中，同样也存在于LRU 列表中（因为不可能每次都将脏页存放到flush list中）</p>
<p>flush list用来管理将脏页写回到磁盘</p>
</li>
<li><p>脏页相关命令</p>
<ul>
<li><p>查看脏页</p>
<p><code>select table_name,space,page_number,page_type from INNODB_BUFFER_PAGE_LRU where OLDEST_MODIFICATION&gt;0;</code></p>
<p>或者是</p>
<p><code>show engine innodb status\G</code></p>
<p>中的Modified db pages</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>重做日志缓冲</p>
<ul>
<li><p>定义</p>
<p>首先将重做日志信息存放到这个缓冲区，然后按照一定频率将其刷新到重做日志文件</p>
</li>
<li><p>刷新到重做日志文件时机</p>
<ul>
<li>Master thread每一秒将其刷新到重做日志</li>
<li>每个事物提交时会将重做日志刷新到重做日志</li>
<li>当重做日志缓冲池剩余空间小于1/2时，重做日志缓冲刷新到重做日志文件</li>
</ul>
</li>
<li><p>重做日志缓冲区大小</p>
<ul>
<li><p>只需要保证每秒产生的事务量在这个缓冲区大小之内即可</p>
</li>
<li><p>一般默认是8M，满足绝大部分应用</p>
</li>
<li><p>查看指令</p>
<p><code>show variables like &#39;innodb_log_buffer_size&#39;\G</code></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>额外内存池</p>
<p>InnoDB对内存管理是内存堆的方式进行</p>
<p>innodb_buffer_pool_size:主要针对InnoDB表性能影响最大的一个参数。功能与Key_buffer_size一样。InnoDB占用的内存，除innodb_buffer_pool_size用于存储页面缓存数据外，另外正常情况下还有大约8%的开销，主要用在每个缓存页帧的描述、adaptive hash、缓冲控制对象等数据结构，如果不是安全关闭，启动时还要恢复的话，还要另开大约12%的内存用于恢复，两者相加就有差不多21%的开销。</p>
<p>因此在申请了很大的InnoDB缓冲池时，也应考虑相应增加这个值</p>
</li>
</ul>
<h3 id="启动、恢复与关闭"><a href="#启动、恢复与关闭" class="headerlink" title="启动、恢复与关闭"></a>启动、恢复与关闭</h3><h4 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h4><ul>
<li><p>对应参数</p>
<p>innodb_fast_shutdown</p>
</li>
<li><p>参数选项</p>
<ul>
<li><p>0</p>
<p>数据库关闭时，InnoDB需要完成所有的full purge和merge Insert buffer，并且将脏页刷新会磁盘</p>
<p>在进行InnoDB升级时，必须将该参数调为0，在关闭数据库</p>
</li>
<li><p>1（默认值）</p>
<p>不需要完成full purge和merge Insert buffer操作，但是缓冲池的数据脏页会刷新会磁盘</p>
</li>
<li><p>2</p>
<p>不完成full purge和merge Insert buffer操作，也不将缓冲池中的数据脏页写回磁盘，而是将日志都写入日志文件，下次数据库启动时会进行恢复操作</p>
</li>
</ul>
</li>
</ul>
<h4 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h4><ul>
<li><p>对应参数</p>
<p>innodb_force_recovery</p>
</li>
<li><p>参数选项</p>
<ul>
<li><p>0 （默认）</p>
<p>进行所有的恢复操作</p>
</li>
<li><p>1</p>
<p>忽略检查到的corrupt页</p>
</li>
<li><p>2</p>
<p>阻止Master Thread线程的运行</p>
</li>
<li><p>3</p>
<p>不进行事务的回滚操作</p>
</li>
<li><p>4</p>
<p>不进行插入缓冲的合并操作</p>
</li>
<li><p>5</p>
<p>不查看撤销日志（undo_log），InnoDB存储引擎会将未提交的事务视为已提交</p>
</li>
<li><p>6</p>
<p>不进行前滚操作</p>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">文件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:38:21" itemprop="dateModified" datetime="2021-08-27T22:38:21+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%96%87%E4%BB%B6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%96%87%E4%BB%B6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><h4 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h4><ul>
<li><p>位置查询</p>
<p><code>show variables like &#39;log_error&#39;\G</code></p>
</li>
</ul>
<h4 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h4><ul>
<li><p>相关指令</p>
<ul>
<li><p>查看mysql 慢查询相关信息</p>
<p><code>show variables like &#39;%slow%&#39;;</code></p>
</li>
<li><p>慢查询时间标准 (只有&gt;该时间会被记录)</p>
<p><code>show variables like &#39;long_query_time&#39;\G</code></p>
</li>
<li><p>查询慢查询</p>
<p><code>show variables like &#39;log_slow_queries&#39;\G</code></p>
</li>
<li><p>开启记录未使用索引的sql的功能</p>
<p><code>show variables like &#39;log_queries_not_using_indexes&#39;\G</code></p>
<p>如果开启了，那么会将没有使用索引的sql也添加到慢查询日志中去</p>
</li>
<li><p>设置允许记录到慢查询日志中每分钟未使用索引sql的语句次数</p>
<p><code>show variables like &#39;log_throttle_queries_not_using_indexes&#39;\G</code></p>
<p>默认为0，表示无限制</p>
</li>
<li><p>开启mysql慢查询</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/afeige/p/10896389.html">https://www.cnblogs.com/afeige/p/10896389.html</a></p>
<p>注意：对应的目录需要给mysql用户权限</p>
</li>
<li><p>输出日志格式设置 (是可以动态进行调整的，并且是全局有效的)</p>
<p><code>show variables like &#39;log_output&#39;\G</code></p>
<p>默认是file</p>
<p>可以改为table</p>
<p><code>set global log_output=&#39;table&#39;;</code></p>
<p>测试 select sleep(11);</p>
<p><code>show create table slow_query.log\G</code> （可以看到默认的表的引擎是CSV，用户可以自己进行设置）</p>
<p><code>select * from mysql.slow_log\G</code></p>
</li>
</ul>
</li>
<li><p>有条件的查询慢sql</p>
<p><code>mysqldumpslow -s al -n 10 xxx.log</code></p>
<p>查询执行时间最长的10条sql语句</p>
</li>
<li><p>不止可以根据运行时间记录slow log,还可以根据指定的逻辑IO次数将对应的sql语句加入到slow log中</p>
</li>
</ul>
<h4 id="查询日志"><a href="#查询日志" class="headerlink" title="查询日志"></a>查询日志</h4><ul>
<li><p>mysql所有的查询都会记录在此处，默认是不开启的</p>
</li>
<li><p>相关命令</p>
<p><code>show variables like &#39;log_output&#39;;</code></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kerrycode/p/7130403.html">参考</a></p>
</li>
</ul>
<h4 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h4><p><font color=red>二进制日志记录了对MySQL数据库执行更改的所有操作，但是其中不包含select和show操作，如果更改操作并没有真正使得数据库发生了改变，同样也有可能记录到数据中</font></p>
<ul>
<li><p>作用</p>
<ul>
<li>恢复</li>
<li>复制</li>
<li>审计</li>
</ul>
</li>
<li><p>开启二进制日志 <strong>默认是不开启的</strong></p>
<ul>
<li><p>在配置文件中添加参数</p>
<p>log_bin = {name} (如果不指定name的话则默认二进制文件名为主机名)</p>
</li>
<li><p>重启mysql</p>
</li>
<li><p>查看是否开启</p>
<p><code>show variables like &#39;log_bin&#39;;</code></p>
</li>
</ul>
</li>
<li><p>二进制日志配置的相关参数</p>
<ul>
<li><p>max_binlog_cache  </p>
<p>单个日志文件的最大大小，达到就产生新的二进制日志文件</p>
</li>
<li><p>binlog_cache_size</p>
<p>缓存中二进制日志大小，每个session都会自动分配一个大小为binlog_cache_size的缓存，当一个事务的记录大于该值时会将缓冲中的日志写入到一个临时文件中</p>
</li>
<li><p>sync_binlog</p>
<p>设置同步磁盘的策略</p>
<p>sync_binlog[N] 表示每写多少次缓冲就同步到磁盘</p>
</li>
<li><p>binlog_format （<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42351363/article/details/113424251">参考</a>）</p>
<ul>
<li><p>查看当前格式的内容</p>
<p><code> show variables like &#39;binlog_format&#39;;</code></p>
</li>
<li><p>statement </p>
<p>将对应的sql记录下来</p>
<p><font color=red>注意：statement在read committed事务隔离级别下会产生主从逻辑顺序不一致的现象。比如开启了一个事务（删除记录a &lt;5）但是没有提交，这时候提交了另外一个事务(插入记录a=5)，虽然在master上是先执行了删除，然后插入，但是在从服务器上记录的就是单纯的sql，也就是先插后删，从而导致主从不一致</font></p>
</li>
<li><p>row (貌似默认是row格式)</p>
<p>将每一行被影响的过程记录下来</p>
<p><strong>强烈推荐使用row格式记录二进制日志</strong></p>
</li>
<li><p>mixed</p>
<p>自动根据SQL采用statement或者row的日志格式策略</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>查看二进制日志文件记录的内容</p>
<ul>
<li><p>找到当前记录的位置</p>
<p><code>show master status</code></p>
</li>
<li><p>查看</p>
<ul>
<li><p>statement格式记录的</p>
<p><code>mysqlbinlog --start-position=203 &#123;binlog file name&#125;</code></p>
</li>
<li><p>row格式记录的</p>
<p><code>mysqlbinlog -vv --start-position=203 &#123;binlog file name&#125;</code></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="pid文件"><a href="#pid文件" class="headerlink" title="pid文件"></a>pid文件</h4><ul>
<li><p>作用</p>
<p>将当前mysql进程的进程ID写入到该文件中</p>
<p>MySQL pid 文件的作用是：在数据文件是同一份，但端口不同的情况下，防止同一个数据库被启动多次。</p>
</li>
<li><p>查看pid文件位置</p>
<p><code>show variables like &#39;pid_file&#39;;</code></p>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E6%88%AA%E5%8F%96%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E6%88%AA%E5%8F%96%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">查询截取分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-24 08:26:07" itemprop="dateModified" datetime="2021-02-24T08:26:07+08:00">2021-02-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E6%88%AA%E5%8F%96%E5%88%86%E6%9E%90/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9F%A5%E8%AF%A2%E6%88%AA%E5%8F%96%E5%88%86%E6%9E%90/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><ol>
<li>观察，至少跑一天，查看生产 的慢SQL情况</li>
<li>开启慢查询日志，设置阈值，比如超过5s的就是慢SQL，将其抓取出来</li>
<li>explain+慢SQL分析</li>
<li>show profile</li>
<li>进行sql数据库服务器的参数调优</li>
</ol>
<h3 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h3><ul>
<li><p>永远小表驱动大表</p>
<ul>
<li><p>exits</p>
<p>将主查询的数据，放到子查询中做条件验证，根据验证结果（true或false）来决定主查询的数据结构是否得以保留</p>
</li>
</ul>
</li>
<li><p>order by关键字优化</p>
<ul>
<li><p>order by子句，尽量使用Index方式排序，避免使用filesort方式排序</p>
<p>排序如果按照顺序一升一降排序，也会导致最终的使用filesort</p>
</li>
<li><p>尽可能在索引列上完成排序操作，遵照索引建立的最佳左前缀</p>
</li>
<li><p>如果不在索引列上，filesort有两种算法：MySQL会启动双路排序和单路排序</p>
<ul>
<li><p>双路排序</p>
<p>MySQL4.1之前使用双路排序，字面意思是两次扫描磁盘，最终得到数据</p>
</li>
<li><p>单路排序</p>
<p>MySQL4.1之后使用单路排序，从磁盘读取查询需要的列，按照order by列在buffer对他们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据，并且把随机io变成了顺序io，但是它会使用更多的 空间，因为它把每一行都保存在唉内存中了。</p>
</li>
<li><p>两者比较</p>
<p>总体而言，单路排序好于双路排序，但是单路排序如果无法一次完成，则需要多次io，而双路排序是稳定的，始终都是两次io</p>
<p>在sort_buffer中，单路排序比双路排序多占用很多空间，有可能取出的数据总大小超过了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据进行排序，排序完再取sort_buffer的容量大小，再排序…从而导致多次io</p>
</li>
</ul>
</li>
<li><p>优化策略</p>
<ul>
<li><p>增大sort_buffer_size参数设置</p>
</li>
<li><p>增大max_length_for_sort_data参数设置</p>
</li>
<li><p>尽一切可能在使用order by的时候不要使用select *</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210223210831823.png" alt="image-20210223210831823" style="zoom:50%;" /></li>
</ul>
</li>
</ul>
</li>
<li><p>group by</p>
<p>group by的实质是先排序后分组</p>
<p>其他与order by一样，多了一条如下：</p>
<p>where 高于having，能写在where限定的条件就不要去having限定</p>
</li>
</ul>
<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>默认情况下MySQL没有开启慢查询日志，需要我们手动设置该参数</p>
<p>如果不是调优需要，则不要开启该功能</p>
<ul>
<li><p>开启慢查询日志</p>
<ul>
<li><p>查看</p>
<p>show variables like ‘%slow_query_log%’;</p>
</li>
<li><p>开启</p>
<p>set global slow_query_log=1;</p>
<p>只会对当前数据库生效，重启MySQL就会失效</p>
<p>如果想要永久生效</p>
<p>则需要在my.cnf中的[mysqld]下增加或修改参数</p>
<p>slow_query_log=1</p>
<p>slow_query_log_file =  /var/lib/mysql/VM-12-5-centos-slow.log</p>
<p>重启MySQL即可</p>
</li>
<li><p>查看对应的阈值</p>
<p>show variables like ‘long_query_time%’</p>
<p>假如运行时间正好等于long_query_time的情况则不会被记录下来</p>
<p>如果想要其他阈值，可以直接修改 :set long_query_time = 3;(<font color=red>注意</font>：直接修改的话看不到long_query_time有变化，需要重新登录MySQL才会看到修改的值,也可以通过show global variables like ‘long_query_time%’查看)</p>
<p>也可以通过my.cnf进行修改</p>
</li>
<li><p>查看</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210223213433512.png" alt="image-20210223213433512" style="zoom:50%;" /></li>
<li><p>查看有多少慢SQL</p>
<p>show global status like ‘%Slow_queries’;</p>
</li>
<li><p>配置</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210223213655.png" alt="image-20210223213650510" style="zoom:50%;" /></li>
</ul>
</li>
<li><p>日志分析工具</p>
<p>mysqldumpslow  –help 可以查看其用法</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210223214027917.png" alt="image-20210223214027917" style="zoom:50%;" /></li>
</ul>
<h3 id="show-profile"><a href="#show-profile" class="headerlink" title="show profile"></a>show profile</h3><p>MySQL提供可以用来分析当前会话中语句执行的资源消耗情况</p>
<ul>
<li><p>默认情况下show profile是处于关闭状态的，只保存最近15次 的运行结果</p>
<ul>
<li><p>是否支持</p>
<p>show variables like ‘profiling’;</p>
</li>
<li><p>开启功能</p>
<p>set profiling = on; (也只是暂时生效，重启就会失效)</p>
</li>
<li><p>运行SQL</p>
</li>
<li><p>查看结果 show profiles</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210223220853.png" alt="image-20210223220847797" style="zoom:50%;" /></li>
<li><p>诊断SQL，show profile cpu,block io for query 上一步前面的问题SQL数字号码</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210223220953798.png" alt="image-20210223220953798" style="zoom:50%;" />

<p>当然除了cpu、io也可以查看其它的，如下</p>
<img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210223221057082.png" alt="image-20210223221057082" style="zoom:50%;" /></li>
<li><p>日常开发需要注意的结论</p>
<p>出现了一下字眼则说明该SQL比较危险</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210223221307.png" alt="image-20210223221302953" style="zoom:50%;" /></li>
</ul>
</li>
</ul>
<h3 id="全局查询日志"><a href="#全局查询日志" class="headerlink" title="全局查询日志"></a>全局查询日志</h3><p>主要是用于测试环境，将所有的SQL抓取出来查看</p>
<ul>
<li><p>配置启用</p>
<p>在my.cnf中设置如下：</p>
<p>general_log = 1</p>
<p>General_log_file = {path}</p>
<p>Log_output =FILE</p>
</li>
<li><p>命令启用</p>
<p>set global general_log = 1;</p>
<p>set global log_output = ‘TABLE’</p>
<p>这样开启之后我们所有的SQL语句都会被记录到mysql库中 的general_log表中，查看如下</p>
<p>select * from mysql.general_log;</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210223222510.png" alt="image-20210223222503338" style="zoom:50%;" /></li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E7%B4%A2%E5%BC%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E7%B4%A2%E5%BC%95/" class="post-title-link" itemprop="url">索引</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-11 09:16:49" itemprop="dateModified" datetime="2021-08-11T09:16:49+08:00">2021-08-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E7%B4%A2%E5%BC%95/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E7%B4%A2%E5%BC%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>索引是一种帮助数据库高效获取数据的数据结构</p>
<p>排好序的快速查找数据结构</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ul>
<li>排序</li>
<li>查找</li>
</ul>
<h2 id="原则"><a href="#原则" class="headerlink" title="原则"></a>原则</h2><ol>
<li>不是索引越多越好</li>
<li>不要对经常变动的数据添加索引</li>
<li>小数据量的表不需要添加索引</li>
<li>索引一般加在经常需要查询的字段上</li>
</ol>
<h2 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h2><ul>
<li>占用磁盘空间</li>
<li>虽然提升了查询速度，但是会降低表的更新速度，如对表进行INSERT、UPDATE和DELETE。因为每次更新表都需要重新对索引进行调整</li>
</ul>
<p><font color=red>注意：索引是需要不停的分析，逐步优化出来的</font></p>
<h2 id="索引分类"><a href="#索引分类" class="headerlink" title="索引分类"></a>索引分类</h2><ul>
<li><p>单值索引：该索引只包含一个字段</p>
</li>
<li><p>唯一索引：索引列的值必须是唯一的，但是允许有空值</p>
</li>
<li><p>复合索引 （联合索引）</p>
<p><font color=red>最重要的一点在于最左匹配原则，不能跳索引</font></p>
<p>因为对于联合索引来说构建二叉树是按照键值的顺序来进行插入的，比如说是（a,b）这2个字段构建的联合索引</p>
</li>
</ul>
<p>​       <img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210810093211.png" alt="image-20210810093201946" style="zoom:50%;" /></p>
<p>​        可以看到是排序是按照a然后b，因此需要按照最左匹配原则进行查询</p>
<p>​       联合索引的一个好处是对第二个键值已经进行了排序，如果查询时a为一个固定值来说的话</p>
<ul>
<li><p>聚集索引</p>
<p>按照每张表的主键构造一棵B+树，同时==叶子==节点中存放的即为==整张表==的行记录数据（这里指的不是单个叶子节点，单个叶子节点只是一部分表的行记录数据，这里指的是所有叶子节点加起来就是整张表的行记录数据），也将聚簇索引的叶子节点称为数据页</p>
<ul>
<li><p>组成</p>
<ul>
<li>非数据页的索引页存放的仅仅是键值以及指向数据页的偏移量，<font color=red>而不是一个完整的行记录</font></li>
<li>数据页的存放是完整的行记录</li>
</ul>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210808100250.png" alt="image-20210808100241025"></p>
</li>
</ul>
</li>
<li><p>辅助索引</p>
<p>辅助索引的非叶子节点包含对应的辅助索引键值，叶子节点不同于聚集索引，<font color=red>不含行数据</font>，而是包含了一个<font color=red>聚集索引键（主键）</font>，通过查找非聚集索引B+树找到其叶子节点上的主键，然后再去聚集索引B+树上去查找对应的行数据。其树高一般也是2~4层，故查询次数较聚集索引多了一倍（因为有两次查询过程，先是辅助索引-&gt;聚集索引，然后是聚集索引-&gt;辅助索引，<strong>相当于是查找了2棵树</strong>）。</p>
<ul>
<li><p>组成</p>
<ul>
<li><p>非叶子节点是辅助索引键值（辅助索引，聚集索引）</p>
</li>
<li><p>叶子节点是聚集索引键值</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210808102448.png" alt="image-20210808102446193"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>自适应哈希索引</p>
<p>该索引是InnoDB自己建立的。经常访问的辅助索引数据会自动被生成到hash索引里面去(最近连续被访问三次的数据)，自适应哈希索引通过缓冲池的B+树构造而来，因此建立的速度很快。</p>
<p>它会占用InnoDB buffer pool</p>
<p>缺点：只能用于等值查询</p>
<p>查看是否开启：<code>show variables like &#39;innodb_adaptive_hash_index;</code></p>
</li>
</ul>
<h2 id="索引创建"><a href="#索引创建" class="headerlink" title="索引创建"></a>索引创建</h2><ul>
<li><p>fast index creation</p>
<ul>
<li><p>辅助索引创建</p>
<ul>
<li><p>5.5之前</p>
<p>重建表</p>
</li>
<li><p>5.5</p>
<p>InnoDB引擎会对创建索引的表加上一个S锁，在创建的过程中不需要重建表，因此只能进行<font color=red>读操作</font></p>
</li>
<li><p>5.6及其之后</p>
<p>允许在辅助索引创建或删除的同时进行增删改查</p>
<p>几种在创建和删除辅助索引时的加锁方案：</p>
<ul>
<li><p>None</p>
<p>不添加任何锁</p>
</li>
<li><p>share</p>
<p>添加s锁，只允许读，写操作会被阻塞</p>
</li>
<li><p>exclusive</p>
<p>添加x锁，阻塞所有线程</p>
</li>
<li><p>default</p>
<p>通过判断事务的最大并发性来选择加锁方案</p>
</li>
</ul>
<p><strong>原理</strong></p>
<p>执行辅助索引创建或删除的时候的同时将DML操作(增删改)日志写入到一个缓存中，待索引完成创建之后重做应用到表上。</p>
<p>缓存的大小由参数<code>innodb_online_alter_log_max_size</code>,默认大小为欸128M</p>
<p><font color=red>注意：在索引创建的过程中，不会使用到正在创建的索引</font></p>
</li>
</ul>
</li>
<li><p>对于主键的创建和删除需要重建一张表，其过程如下</p>
<ol>
<li><p>创建一张新的临时表</p>
</li>
<li><p>将原表数据导入到临时表</p>
</li>
<li><p>删除原表</p>
</li>
<li><p>临时表重命名为原来的表名</p>
<p><font color=red>注意：临时表的创建路径是通过tmpdir进行设置的，因此需要保证tmpdir要有足够的空间可以存放临时表</font></p>
<p><strong>索引最好提前创建，尤其是主键索引</strong></p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="索引语法"><a href="#索引语法" class="headerlink" title="索引语法"></a>索引语法</h2><ul>
<li><p>创建索引</p>
<p>CREATE [unique] INDEX BKNameIdx ON books (bookname);</p>
<p>alter mytable add [unique] index [indexname] on [columnname]</p>
</li>
<li><p>删除索引</p>
<p>drop index [indexname] on mytable</p>
</li>
<li><p>show index from tablename</p>
</li>
<li><p>可以只对当前字段前n个字节构建索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table t add key idx_b(b(100)) #表示只对b字段的前100个字节构成辅助索引</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="索引的数据结构"><a href="#索引的数据结构" class="headerlink" title="索引的数据结构"></a>索引的数据结构</h2><ul>
<li><p>BTree</p>
<p><font color=red>B+树索引并不能找到一个给定键值的具体行，找到的只是被查找数据行所在的页，然后数据库将页读取到内存中，在内存中进行查找</font></p>
</li>
<li><p>Hash索引</p>
<p>InnoDB的哈希索引是自适应的，也就是说InnoDB会根据当前的表的使用情况，自动判断是否是生产哈希索引好一些，如果建立哈希索引能够提高查询效率，那么会建立哈希索引，如果不能则不建立该索引</p>
</li>
<li><p>full-text索引</p>
</li>
<li><p>R-Tree索引</p>
</li>
</ul>
<h2 id="建立索引的情况"><a href="#建立索引的情况" class="headerlink" title="建立索引的情况"></a>建立索引的情况</h2><ol>
<li>主键自动建立唯一索引</li>
<li>频繁作为查询条件的字段应该作为索引</li>
<li>查询中与其他表关联的字段，外键关系建立索引</li>
<li>查询中排序字段，排序字段若通过索引去访问将大大提高排序速度</li>
<li>查询中统计或分组的字段</li>
<li>字段具有高选择性，也就是该字段包含的值有很多种，例如性别只有两种字段就不应该建立索引</li>
</ol>
<h2 id="不建立索引的情况"><a href="#不建立索引的情况" class="headerlink" title="不建立索引的情况"></a>不建立索引的情况</h2><ol>
<li><p>表记录比较少（一般以300w为界限，虽然官方文档上说支持500w-600w）</p>
</li>
<li><p>经常增删改的表</p>
</li>
<li><p>如果某个数据列包含许多重复的内容，为他建立索引就没有太大的实际效果</p>
<p>按照下面的原则来判断：</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210221212309.png" alt="image-20210221212257372" style="zoom:50%;" /></li>
</ol>
<h2 id="索引失效-（注意MySQL版本的不同可能导致以下情况发生变化）"><a href="#索引失效-（注意MySQL版本的不同可能导致以下情况发生变化）" class="headerlink" title="索引失效 （注意MySQL版本的不同可能导致以下情况发生变化）"></a>索引失效 （<font color=red>注意MySQL版本的不同可能导致以下情况发生变化</font>）</h2><p>索引所建立的顺序用不上了</p>
<p>常见索引失效的原因如下：</p>
<ul>
<li><p>未遵守最左前缀法则  （where后面的条件）</p>
<p>最左前缀法则：查询从索引的最左前列开始并且<font color=red>不跳过索引中的列</font>（<font color=red>一定要按照顺序</font>）</p>
</li>
<li><p>不能在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描</p>
</li>
<li><p>存储引擎不能使用索引中范围条件右边的列</p>
<img src="/Volumes/共享文件夹/Snipaste_2021-02-23_09-30-58.png" alt="Snipaste_2021-02-23_09-30-58" style="zoom:50%;" />

<p>​    最下面的查询在索引列上使用了范围导致后面的pos索引失效了</p>
</li>
<li><p>尽量使用索引覆盖（只访问索引的查询（索引列和查询列一致）），减少select *</p>
</li>
<li><p>MySQL在使用不等于（！=或者&lt;&gt;）的时候无法使用索引会导致全表扫描</p>
<p>MySQL 8.0用到了索引，type是range，之前的版本type是ALL</p>
</li>
<li><p>is null，is not null 也无法使用索引</p>
</li>
<li><p>like以通配符开头（’%abc’）mysql索引失效会变成全表扫描</p>
<p>主要%在最左边，则出现全表扫描</p>
<p>解决方法：</p>
<p>查询的字段为遵循覆盖索引原则</p>
</li>
<li><p>字符串不加单引号会导致索引失效</p>
<p>因为MySQL底层会帮我们进行转换，也就是变相在索引列上进行了操作，导致索引失效</p>
</li>
<li><p>少用or，用它来连接时索引会失效</p>
</li>
<li><p>group by基本上都需要进行排序，会有临时表产生</p>
</li>
</ul>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210223100444.png" alt="Snipaste_2021-02-23_10-04-09" style="zoom:50%;" />



<h2 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h2><ul>
<li><p>left join</p>
<p>右表建立索引</p>
</li>
<li><p>left join</p>
<p>左表建立索引</p>
</li>
<li><p>对于单键索引，尽量选择针对当前query过滤性更好的索引</p>
</li>
<li><p>在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠前越好</p>
</li>
<li><p>在选择组合索引的时候，尽量选择可以包含当前query中的where子句中更多的索引字段</p>
</li>
<li><p>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</p>
</li>
<li><p>order by 字段需要按照建立索引的顺序</p>
<p>例如索引为index_abc,则order by a ,b,c 最为合适</p>
<p>如果order by a ,c,b 则可能会用到using filesort</p>
<p>如果c为常量则不会产生影响</p>
</li>
<li><p>对于应用程序的几张核心表，可以在非高峰时间执行<code>analyze table &#123;table name&#125;</code>,能够是优化器和索引更好的为我们工作，因为执行该命令会对Cardinality进行更新，而<strong>优化器会根据这个值来判断是否使用这个索引</strong></p>
<p><font color=red>Cardinality这个值对于索引来说很重要，因为它表示索引中不重复记录数量的预估值</font></p>
<p>该值的更新策略为</p>
<ul>
<li>表中的1/16的数据已经发生了变化</li>
<li>stat_modified_counter&gt;2000000000</li>
</ul>
<p>每次更新时是对索引B+树中的叶子节点进行随机采样，每次采取8页，具体采取的页数通过参数<code>innodb_stats_sample_pages</code>进行控制</p>
</li>
</ul>
<h2 id="索引的使用"><a href="#索引的使用" class="headerlink" title="索引的使用"></a>索引的使用</h2><ul>
<li><p>覆盖索引 （<a target="_blank" rel="noopener" href="https://www.cnblogs.com/myseries/p/11265849.html%EF%BC%89">https://www.cnblogs.com/myseries/p/11265849.html）</a></p>
<ul>
<li><p>覆盖索引的定义</p>
<p>从辅助索引中就可查询得到记录，而不需要查询聚集索引中的记录</p>
</li>
<li><p>好处</p>
<p>因为一般的对于辅助索引的查询会导致回表查询，也就是先查辅助索引，再找主键索引，最终查询到具体的数据，可以大大减少IO操作</p>
</li>
<li><p>查看是否出发覆盖索引</p>
<p>explain的输出结果Extra字段为<strong>Using index</strong>时，能够触发索引覆盖</p>
</li>
<li><p>注意</p>
<p><font color=red>对于SQL的统计操作，有时候是可以利用到覆盖索引信息的</font></p>
<p>比如对于辅助索引（id，date）</p>
<p>执行select count(*) from table where date&gt;=’2021-1-1’ and date&lt;=’2021-8-10’</p>
<p>通过辅助索引就可以查询成功，因为查询到日期之后，可以通过id进行统计</p>
</li>
</ul>
</li>
<li><p>索引提示</p>
<p>强制告诉mysql使用哪个索引去查询</p>
<p><code>select * from table use index(a) where a = 1 and b = 2 </code></p>
<p><code>select * from force table use index(a) where a = 1 and b = 2 </code></p>
<p>第二个更可靠，第一个有可能还是会使用优化器自己选择的索引</p>
</li>
<li><p>multi-range read （MRR）</p>
<ul>
<li><p>好处</p>
<ul>
<li>使得数据访问变得较为顺序</li>
<li>减少缓冲池中页被替换的次数</li>
<li>批量处理对键值的查询操作</li>
</ul>
</li>
<li><p>优化场景</p>
<ul>
<li>range</li>
<li>ref</li>
<li>eq_ref</li>
</ul>
</li>
<li><p>本质上来说是空间换时间</p>
</li>
</ul>
</li>
<li><p>index condition pushdown （ICP）</p>
<ul>
<li><p>好处</p>
<p>在取出索引的同时会判断是否可以进行where条件的过滤（如果索引中有字段在where条件中）</p>
</li>
<li><p>例子</p>
<p>比如有一个联合索引为（zip_code,last_name,first_name）</p>
<p>查询如下：</p>
<p><code>select * from people where zip_code=&#39;123&#39; and last_name like &#39;%hello%&#39; and first_name like &#39;%world%&#39;;</code></p>
<p>如果不开启ICP，则会先过滤出所有的zipcode=123的记录，然后再过滤where之后的两个条件，如果支持ICP，则会在索引取出的同时进行where条件的过滤</p>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/MySQL%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/MySQL%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">MySQL事物</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:41:34" itemprop="dateModified" datetime="2021-08-27T22:41:34+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/MySQL%E4%BA%8B%E5%8A%A1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/MySQL%E4%BA%8B%E5%8A%A1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h3><p>ACID</p>
<p>A：原子性</p>
<p>C：一致性</p>
<p>I：隔离性</p>
<p>D: 持久性</p>
<h3 id="事务的实现"><a href="#事务的实现" class="headerlink" title="事务的实现"></a>事务的实现</h3><h4 id="redo"><a href="#redo" class="headerlink" title="redo"></a>redo</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>重做日志用来实现事务的持久性，其包含两部分</p>
<ul>
<li>内存中的重做缓冲日志</li>
<li>重做日志文件</li>
</ul>
<h5 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h5><ul>
<li>保证事务的持久性</li>
</ul>
<h5 id="写入机制"><a href="#写入机制" class="headerlink" title="写入机制"></a>写入机制</h5><ul>
<li><p>写入策略</p>
<p>在事务提交之前就需要将该事务的所有日志写入到重做日志文件进行持久化</p>
<p>事务的日志一开始是存储在重做日志缓冲中的，写入时先写入到文件系统缓存，然后调用依次fsync操作，fsync的效率取决于磁盘，因此数据库的性能也取决于磁盘</p>
<p>当然，写入的策略存在多种选项，一般通过innodb_flush_log_at_trx_commit控制写入磁盘的策略</p>
<ul>
<li><p>1</p>
<p>事务提交时必须调用依次fsync操作</p>
</li>
<li><p>0</p>
<p>事务提交时不进行写入重做日志操作，这个操作仅在master thread完成，master thread每隔1s进行依次重做日志的fsync操作</p>
</li>
<li><p>2</p>
<p>事务提交时仅写入到文件系统缓存中，不进行fsync操作</p>
</li>
</ul>
</li>
<li><p>写入时机</p>
<p>redo log buffer根据一定的规则将内存中的log block刷新到磁盘</p>
<ul>
<li>事务提交时</li>
<li>当log buffer中有一半的内存空间已经被使用时</li>
<li>log checkpoint时</li>
</ul>
</li>
</ul>
<h5 id="redo-log组成"><a href="#redo-log组成" class="headerlink" title="redo log组成"></a>redo log组成</h5><ul>
<li><p>log block</p>
<ul>
<li><p>概念</p>
<p>重做日志都是以512字节进行保存的，如果一个页中产生的重做日志数量&gt;512字节，那么需要分割为多个重做日志进行存储</p>
<p>正是因为512字节也是磁盘扇区的大小，因此写入可以保证原子性，不需要double write技术</p>
<p>是redo log buffer的基本组成单位</p>
</li>
<li><p>组成</p>
</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>log block header(12字节)</th>
<th>log block body（实际存放数据的地方 492字节）</th>
<th>log block tail（8字节）</th>
</tr>
</thead>
</table>
<h5 id="重做日志格式"><a href="#重做日志格式" class="headerlink" title="重做日志格式"></a>重做日志格式</h5><p><font color=red>重做日志格式是基于页的</font></p>
<ul>
<li><p>结构</p>
<table>
<thead>
<tr>
<th>redo_log_type</th>
<th>space</th>
<th>page_no</th>
<th>redo log body</th>
</tr>
</thead>
</table>
<ul>
<li>redo_log_type  重做日志类型</li>
<li>space 表空间的ID</li>
<li>page_no 页的偏移量</li>
<li>redo log body 根据不同的重做日志类型会有不同的存储内容</li>
</ul>
</li>
</ul>
<h5 id="LSN"><a href="#LSN" class="headerlink" title="LSN"></a>LSN</h5><ul>
<li><p>概念</p>
<p>日志序列号，占8个字节，单调递增</p>
</li>
<li><p>含义</p>
<ul>
<li>重做日志写入的总量</li>
<li>checkpoint的位置</li>
<li>页的版本</li>
</ul>
</li>
<li><p>LSN不仅在重做日志中，还在每个页中，在每个页的头部有一个FILE_PAGE_LSN</p>
<p>数据库启动时</p>
<p>如果该页中的LSN&lt;写入重做日志中的LSN -&gt; 需要进行恢复操作 （比如修改操作，会修改内存中对应页的LSN，如果此时发生了宕机，那么内存数据页中的LSN不会被记录到磁盘对应的数据页中，如果重启数据库，会发现重做日志中对应数据页中的LSN与重做日志的LSN不同，那么就会对该数据页执行恢复操作）</p>
<p>如果该页中的LSN&gt;=写入重做日志中的LSN -&gt; 不需要重做 （这种情况出现于数据页的刷盘进度超过了日志页的刷盘进度）</p>
</li>
<li><p>详细的LSN过程如下</p>
<p>innodb从执行修改语句开始：</p>
<p>(1).首先修改内存中的数据页，并在数据页中记录LSN，暂且称之为data_in_buffer_lsn；</p>
<p>(2).并且在修改数据页的同时(几乎是同时)向redo log in buffer中写入redo log，并记录下对应的LSN，暂且称之为redo_log_in_buffer_lsn；</p>
<p>(3).写完buffer中的日志后，当触发了日志刷盘的几种规则时，会向redo log file on disk刷入重做日志，并在该文件中记下对应的LSN，暂且称之为redo_log_on_disk_lsn；</p>
<p>(4).数据页不可能永远只停留在内存中，在某些情况下，会触发checkpoint来将内存中的脏页(数据脏页和日志脏页)刷到磁盘，所以会在本次checkpoint脏页刷盘结束时，在redo log中记录checkpoint的LSN位置，暂且称之为checkpoint_lsn。</p>
<p>(5).要记录checkpoint所在位置很快，只需简单的设置一个标志即可，但是刷数据页并不一定很快，例如这一次checkpoint要刷入的数据页非常多。也就是说要刷入所有的数据页需要一定的时间来完成，中途刷入的每个数据页都会记下当前页所在的LSN，暂且称之为data_page_on_disk_lsn。</p>
</li>
</ul>
<h5 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h5><p>InnoDB存储在启动时不管上次数据库运行是否正常关闭们都会尝试进行恢复操作</p>
<p>因为记录的是物理日志，因此恢复速度比较快</p>
<p>恢复会从checkpoint表示的LSN处进行恢复</p>
<p>物理日志还有一个好处就是幂等，意思就是如果重复执行一个操作，那么最终恢复的效果都是一样的</p>
<p>比如重复插入一条记录（允许重复插入），那么最终物理日志恢复起来，始终都只有一条记录，而不是多条记录</p>
<h4 id="undo"><a href="#undo" class="headerlink" title="undo"></a>undo</h4><h5 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h5><p>回滚日志</p>
<h5 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h5><ul>
<li><p>如果用户执行的事务或者语句由于某种原因失败了或者不想要了，可以利用undo将其回滚到修改之前的样子，前提是未提交</p>
<p><font color=red>这里需要注意：undo是逻辑日志，因此只是将数据库逻辑的恢复到原来的样子，并非是原来的物理的样子，有可能数据结构和页本身在回滚前后大不相同</font></p>
</li>
<li><p>提高mvcc（多版本控制）</p>
<p>用户读取一行记录时，若该记录被其他事务占用，当前事务可以通过undo读取之前的行版本信息</p>
</li>
</ul>
<h5 id="插入机制"><a href="#插入机制" class="headerlink" title="插入机制"></a>插入机制</h5><ul>
<li><p>记录原理</p>
<p>将用户的操作按照反的方向进行记录下来</p>
<p>比如用户是insert操作，那么就记录未delete操作</p>
</li>
<li><p>存储原理</p>
<p>默认是存放在共享表空间中的</p>
<p>InnoDB对undo的管理采用段的方式。</p>
<p>InnoDB中有rollback segment，每个回滚段中记录了1024个undo log segment，在每个undo log segment段中进行undo页的申请。</p>
<ul>
<li><p>相关参数</p>
<ul>
<li><p>innodb_undo_directory</p>
<p>用于设置rollback segment文件所在路径</p>
</li>
<li><p>innodb_undo_logs</p>
<p>设置rollback_segment的个数，默认值为128</p>
</li>
<li><p>innodb_undo_tablespaces</p>
<p>设置构成rollback_segment文件的数量</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>写入原理</p>
<p>==是在事务开始之前写的undo log==</p>
<p><font color=red>注意：在undo log segment分配页并写入undo log的过程中，同样需要写入重做日志</font></p>
<p>事务提交时InnoDB会做以下两件事情</p>
<ul>
<li>将undo log放入列表中，以供之后的pruge操作</li>
<li>判断undo log所在页是否可以重用，若可以分配给下个事务使用</li>
</ul>
<p>事务提交后不能马上删除undo log以及undo log所在的页，因为可能还有其他事务需要通过undo log得到行记录之前的版本。因此事务提交时将undo log放入到链表中，是否可以最终删除undo log以及undo log所在的页有purge线程来判断</p>
<p>判断是否可以重用条件：</p>
<ul>
<li>undo页的使用空间&lt;3/4 -&gt;可以重用</li>
</ul>
<p>查看undo log的数量</p>
<p><code>show engine innodb status</code></p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210820100717.png" alt="image-20210820100715709"></p>
</li>
</ul>
<h5 id="undo-log格式"><a href="#undo-log格式" class="headerlink" title="undo log格式"></a>undo log格式</h5><ul>
<li><p>insert undo log</p>
<p>记录的是insert操作产生的undo log</p>
<p>事务提交后直接删除并。不需要进行purge操作</p>
</li>
<li><p>update undo log</p>
<p>记录的是delete与update操作产生的undo log</p>
<p>因为该log可能需要提供mvcc，因此不能在事务提交之后就进行删除，提交时需要放入到undo 链表中，等待purge线程进行最后的删除</p>
<p>delete操作并非直接删除记录，而是记录标记为已删除，真正的删除是等待purge操作中完成</p>
<p>update主键的操作分为两部</p>
<ul>
<li>将原主键记录标记为已删除</li>
<li>插入一条新的记录</li>
</ul>
</li>
</ul>
<h5 id="purge"><a href="#purge" class="headerlink" title="purge"></a>purge</h5><p>一个页上允许多个事务的undo log存在</p>
<p>有一个history链表根据事务提交的顺序将undo log进行链接：先提交的事务总在尾端</p>
<p>寻找顺序：</p>
<ul>
<li><p>history链表中找undo log，如果找到了一个事务可以被清理，那么会在该事务所在的页中继续寻找一直到没有事务。</p>
</li>
<li><p>接着继续在history链表中寻找可以被清理的事务</p>
</li>
<li><p>依次循环</p>
</li>
</ul>
<p>相关参数</p>
<ul>
<li><p><code>innodb_purge_batch_size</code></p>
<p>每次purge操作需要清理的undo page的数量</p>
</li>
<li><p><code>innodb_max_purge_lag</code></p>
<p>控制history list的长度</p>
<p>通过延缓DML操作来控制list的长度，其延缓算法为delay = （length(history_list)-innodb_max_purge_lag*10）-5</p>
<p>注意delay针对的是每行的操作，如果一个update操作为5行数据，那么总的delay就是5*delay</p>
<p>delay在每一个purge之后会进行重新计算</p>
</li>
<li><p><code>innodb_max_purge_lag_delay</code></p>
<p>控制delay的最大毫秒数，如果计算得出的delay值大于该值，则会默认为该值，避免由于purge操作缓慢导致其他sql线程出现无限制的等待</p>
</li>
</ul>
<h5 id="group-commit"><a href="#group-commit" class="headerlink" title="group commit"></a>group commit</h5><ul>
<li><p>定义</p>
<p>MYSQL处理日志的一种优化方式,主要为了解决写日志时频繁刷磁盘的问题</p>
</li>
<li><p>好处</p>
<p>一次fsync可以刷新确保多个事务日志被写入文件（redo log、binlog）</p>
</li>
<li><p>过程</p>
<ul>
<li>修改内存中事务对应的信息，并且将日志写入重做缓冲日志</li>
<li>调用fsync将确保日志都从重做日志缓冲写入磁盘</li>
</ul>
<p>因为过程2是一个时间比较长的过程，因此在此过程中其他事务可以进行步骤1的操作，从而达到将多个事务的重做日志通过一次fsync刷新到磁盘</p>
</li>
<li><p>但是对于开启二进制日志的场景下需要开启两阶段事务，也就是需要保证上层二进制日志的写入顺序和InnoDB层的事务提交顺序一致（也就是redo），如果不一致可能会导致以下情况发生：</p>
<p>事务T1、T2、T3,其中T2、T3都提交了，但是由于没有保证写入顺序和事务提交顺序一致，T1在提交时发生了中断，那么在恢复的时候会检测到事务T3上下两层都完成了提交，不需要进行恢复，则T1就会被忽略掉</p>
<p>解决方法：</p>
<ul>
<li>之前是通过添加prepare_commit_mutex以串行的方式来保证顺序性</li>
<li>现在是通过组提交的方式，也就是redo log和binlog都是组提交的方式（<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/618471%EF%BC%89">https://developer.aliyun.com/article/618471）</a></li>
</ul>
</li>
</ul>
<h3 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h3><ul>
<li><p>使用分布式事务时InnoDB的事务隔离级别必须未serializable</p>
</li>
<li><p>XA事务的组成</p>
<ul>
<li><p>资源管理器</p>
<p>提供访问事务资源的方法（通常一个数据库就是一个资源管理器）</p>
</li>
<li><p>事务管理器</p>
<p>协调参与全局事务中的各个事务。需要和参与全局事务的所有资源管理器进行通信</p>
</li>
<li><p>应用程序</p>
<p>定义事务的边界，指定全局事务中的操作</p>
</li>
</ul>
</li>
<li><p>XA事务过程</p>
<p>使用两段式提交</p>
<ul>
<li><p>阶段1</p>
<p>所有参与全局事务的节点都开始准备（prepare），告诉事务管理器他们都准备好了</p>
</li>
<li><p>阶段2</p>
<p>事务管理器告诉资源管理器执行rollback还是commit。如果有任何一个节点显示不能提交则所有节点都被告知回滚</p>
</li>
</ul>
</li>
<li><p>内部事务XA</p>
<p>也就是存储引擎之间的分布式事务</p>
<p>为了保证主从一致性，当事务提交时，InnoDB会先做一个prepare操作，将事务的xid写入，接着进行二进制日志的写入。如果MySQL发生了宕机，则会重启后先检查准备的uxid事务是否已经提交，如果没有，则在存储引擎层再进行一次提交。</p>
</li>
</ul>
<h3 id="不好的事务习惯"><a href="#不好的事务习惯" class="headerlink" title="不好的事务习惯"></a>不好的事务习惯</h3><ul>
<li>开发时不要使用循环提交，尽量将多次提交转为一次提交</li>
<li>注意自动提交</li>
<li>注意自动回滚，应该在自动回滚的同时记录下错误日志</li>
</ul>
<h3 id="长事务"><a href="#长事务" class="headerlink" title="长事务"></a>长事务</h3><ul>
<li><p>含义</p>
<p>执行时间比较长的事务</p>
</li>
<li><p>处理</p>
<p>将长事务转化为小批量的事务</p>
<p>好处</p>
<ul>
<li>知道进度</li>
<li>便于回滚操作</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/MySQL%E5%88%86%E5%8C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/MySQL%E5%88%86%E5%8C%BA/" class="post-title-link" itemprop="url">MySQL分区</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-27 22:40:57" itemprop="dateModified" datetime="2021-08-27T22:40:57+08:00">2021-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/MySQL%E5%88%86%E5%8C%BA/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/MySQL%E5%88%86%E5%8C%BA/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="分区概念"><a href="#分区概念" class="headerlink" title="分区概念"></a>分区概念</h4><p>分区的过程是将一个表或索引分解为多个更小、更可管理的部分。</p>
<h4 id="MySQL中的分区"><a href="#MySQL中的分区" class="headerlink" title="MySQL中的分区"></a>MySQL中的分区</h4><ul>
<li><p>MySQL分区</p>
<ul>
<li>只支持水平分区，也就是将同一个表中的不同行分配到不同的物理文件中</li>
<li>只支持局部分区索引即一个分区中既存放数据有存放索引</li>
</ul>
</li>
<li><p>查看分区是否开启的指令</p>
<p><code>show plugins\G</code></p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210805095032.png" alt="image-20210805095030580"></p>
</li>
<li><p>分区类型</p>
<p>​    创建分区的时候需要注意，如果表中存在主键或者唯一索引时，分区列必须是唯一索引的一个组成部分</p>
<ul>
<li><p>range</p>
<ul>
<li><p>行数据基于属于一个给定连续区间的列值被放入分区</p>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table t_range(</span><br><span class="line">    id int</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by range(id)(</span><br><span class="line">    partition p0 values less than (10),</span><br><span class="line">    partition p1 values less than (20)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>可以看到该表的idb文件会有两个</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210805095558.png" alt="image-20210805095557559"></p>
</li>
<li><p>查看每个分区的情况</p>
<p><code>select * from information_schema.PARTITIONS where table_schema=database() and table_name=&#39;t_range&#39;\G</code></p>
</li>
<li><p>适用情况</p>
<p>日期列的分区</p>
</li>
<li><p>优点</p>
<ul>
<li>删除数据的时候可以直接指定分区即可</li>
<li>加快某些查询操作</li>
</ul>
</li>
<li><p>分区查询优化的要求</p>
<p>优化器只能对year(),to_days(),to_seconds(),unix_timestamp()这类函数进行查询优化</p>
</li>
</ul>
</li>
<li><p>list</p>
<ul>
<li><p>和range类型相比，list分区面向的是离散的值</p>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create table t_list(</span><br><span class="line">    a int,</span><br><span class="line">    b int</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by list(b)(</span><br><span class="line">    partition p0 values in (1,3,5,7,9)</span><br><span class="line">    partition p1 values in (0,2,4,6,8,)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li><p>不同的存储引擎对于错误的处理方式不同</p>
<ul>
<li>MyISAM会将之前的行数据都插入，错误之后的数据不会插入</li>
<li>InnoDB如果遇到错误的，整个插入数据都插入不了</li>
</ul>
</li>
</ul>
</li>
<li><p>hash</p>
<ul>
<li><p>根据用户自定义的表达式的返回值来进行分区</p>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create table t_hash(</span><br><span class="line">    a int,</span><br><span class="line">    b datetime</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by hash(year(b))</span><br><span class="line">partitions 4;</span><br><span class="line"></span><br><span class="line">//线性hash  线性哈希功能使用的一个线性的2的幂（powers-of-two）运算法则</span><br><span class="line">create table t_hash(</span><br><span class="line">    a int,</span><br><span class="line">    b datetime</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by linear hash(year(b))</span><br><span class="line">partitions 4;</span><br></pre></td></tr></table></figure></li>
<li><p>两种hash方式比较</p>
<p>按照线性哈希分区的优点在于增加、删除、合并和拆分分区将变得更加快捷，有利于处理含有极其大量（1000吉）数据的表。它的缺点在于，与使用常规HASH分区得到的数据分布相比，各个分区间数据的分布不大可能均衡。</p>
</li>
</ul>
</li>
<li><p>key</p>
<ul>
<li><p>根据MySQL数据库提供的哈希函数来进行分区</p>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table t_hash(</span><br><span class="line">    a int,</span><br><span class="line">    b datetime</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by key(b)</span><br><span class="line">partitions 4;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>columns分区</p>
<p><font color=red>前面四种分区都必须是整型，但是columns可以是浮点型，可以是日期，可以是字符串类型</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create table t_columns_range(</span><br><span class="line">    a int,</span><br><span class="line">    b datetime</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by range columns(b)(</span><br><span class="line">    partition p0 values less than (2009),</span><br><span class="line">    partition p1 values less than (2010)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>也支持多列分区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">create table rcx(</span><br><span class="line">    a int,</span><br><span class="line">    b int,</span><br><span class="line">    c char(3),</span><br><span class="line">    d int</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by range columns(a,d,c)(</span><br><span class="line">    partition p0 values less than (5,10,&#x27;ggg&#x27;),</span><br><span class="line">    partition p1 values less than (10,20,&#x27;mmm&#x27;),</span><br><span class="line">    partition p1 values less than (MAXVALUE,MAXVALUE,MAXVALUE)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>子分区</p>
<p>在原来分区的基础上继续划分分区</p>
<ul>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">create table ts(</span><br><span class="line">    a int,</span><br><span class="line">   b date</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by range(year(b))(</span><br><span class="line">    subpartition by hash(to_days(b))</span><br><span class="line">    subpartition 2 (</span><br><span class="line">    partition p0 values less than (1990),</span><br><span class="line">    partition p1 values less than (2000),</span><br><span class="line">    partition p1 values less than (MAXVALUE)</span><br><span class="line">);</span><br><span class="line">    </span><br><span class="line">//或者</span><br><span class="line">create table ts(</span><br><span class="line">    a int,</span><br><span class="line">   b date</span><br><span class="line">)engine=innodb</span><br><span class="line">partition by range(year(b))(</span><br><span class="line">    subpartition by hash(to_days(b))(</span><br><span class="line">    partition p0 values less than (1990)(</span><br><span class="line">        subpartition s0,</span><br><span class="line">        subpartition s1,</span><br><span class="line">    ),</span><br><span class="line">    partition p1 values less than (2000)(</span><br><span class="line">        subpartition s2,</span><br><span class="line">        subpartition s3,</span><br><span class="line">    ),</span><br><span class="line">    partition p1 values less than (MAXVALUE)(</span><br><span class="line">        subpartition s4,</span><br><span class="line">        subpartition s5,</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
<li><p>子分区可以用于特别大的表，在多个磁盘空间分别分配数据和索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">create table ts(</span><br><span class="line">    a int,</span><br><span class="line">   b date</span><br><span class="line">)engine=MYISAM</span><br><span class="line">partition by range(year(b))(</span><br><span class="line">    subpartition by hash(to_days(b))(</span><br><span class="line">    partition p0 values less than (1990)(</span><br><span class="line">        subpartition s0,</span><br><span class="line">        data directory = &#x27;/disk0/data&#x27;</span><br><span class="line">        data index = &#x27;/disk0/data&#x27;</span><br><span class="line">        subpartition s1,</span><br><span class="line">        data directory = &#x27;/disk1/data&#x27;</span><br><span class="line">        data index = &#x27;/disk1/data&#x27;</span><br><span class="line">    ),</span><br><span class="line">    partition p1 values less than (2000)(</span><br><span class="line">        subpartition s2,</span><br><span class="line">        data directory = &#x27;/disk2/data&#x27;,</span><br><span class="line">        data index = &#x27;/disk2/data&#x27;,</span><br><span class="line">        subpartition s3,</span><br><span class="line">        data directory = &#x27;/disk3/data&#x27;</span><br><span class="line">        data index = &#x27;/disk3/data&#x27;</span><br><span class="line">    ),</span><br><span class="line">    partition p1 values less than (MAXVALUE)(</span><br><span class="line">        subpartition s4,</span><br><span class="line">        data directory = &#x27;/disk4/data&#x27;</span><br><span class="line">        data index = &#x27;/disk4/data&#x27;</span><br><span class="line">        subpartition s5,</span><br><span class="line">        data directory = &#x27;/disk5/data&#x27;</span><br><span class="line">        data index = &#x27;/disk5/data&#x27;</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><font color=red>注意此处engin是myisam，因为InnoDB会使用表空间自动对数据和索引进行管理，因此会忽略<code>data directory</code>和<code>data index</code>语法</font></p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>分区中的null值</p>
<ul>
<li><p>MySQL运行对null做分区，null值总是小于任何的一个非NULL值，注意在删除最小分区的时候NULL值也有可能被删除</p>
</li>
<li><p>对于list分区，必须声明null值存放在哪个分区</p>
</li>
<li><p>hash和key分区，任何分区函数都会将含有null值的记录返回0</p>
</li>
</ul>
</li>
<li><p>表与分区交换数据</p>
<ul>
<li>要求<ul>
<li>交换的表与分区有着相同的结构，但表不能有分区</li>
<li>非分区表中的数据必须在交换的分区定义内</li>
<li>被交换的表不能含有外键，或者其他表有对该表的外键引用</li>
<li>用户需要有对应的权限</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="MySQL分区适用场景"><a href="#MySQL分区适用场景" class="headerlink" title="MySQL分区适用场景"></a>MySQL分区适用场景</h4><ul>
<li>OLAP（在线分析处理）适用</li>
<li>OLTP（在线事务处理）<strong>不适用</strong></li>
<li>1000w行的表并不一定需要做分区，进行主键查询是有意义的（也就是分区的依据的那个键），其他的查询都会比不分区耗时更多</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/MySQL%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/MySQL%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">MySQL逻辑架构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-07 08:43:29" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:29+08:00">2022-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-17 22:11:23" itemprop="dateModified" datetime="2021-02-17T22:11:23+08:00">2021-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/MySQL%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/MySQL%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <img src="/Users/cooper/Library/Application Support/typora-user-images/image-20210217220732047.png" alt="image-20210217220732047" style="zoom:50%;" />

<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210217220822.png" alt="image-20210217220817623" style="zoom:50%;" />

<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20210217220921.png" alt="image-20210217220915943" style="zoom:50%;" />


      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/21/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><span class="page-number current">22</span><a class="page-number" href="/page/23/">23</a><span class="space">&hellip;</span><a class="page-number" href="/page/35/">35</a><a class="extend next" rel="next" href="/page/23/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cooper</p>
  <div class="site-description" itemprop="description">记录一些学习笔记、小说、随笔</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">341</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/CooperXJ" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CooperXJ" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1789023580@qq.com" title="E-Mail → mailto:1789023580@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cooper</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">648k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:49</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'rOzi1T6uncSYNdx0tp1owOzV-gzGzoHsz',
      appKey     : 'Fk3s6CQBK042e1QltClHnTBP',
      placeholder: "留下邮箱，有回复时你将收到提醒，邮箱不会被公开",
      avatar     : 'wavatar',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
