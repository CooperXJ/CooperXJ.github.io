<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cooperxj.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="记录一些学习笔记、小说、随笔">
<meta property="og:type" content="website">
<meta property="og:title" content="Cooper Notes">
<meta property="og:url" content="http://cooperxj.github.io/page/14/index.html">
<meta property="og:site_name" content="Cooper Notes">
<meta property="og:description" content="记录一些学习笔记、小说、随笔">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Cooper">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://cooperxj.github.io/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Cooper Notes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Cooper Notes</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">obey rules</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/37-%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%86%85%E9%83%A8%E4%B8%B4%E6%97%B6%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/37-%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%86%85%E9%83%A8%E4%B8%B4%E6%97%B6%E8%A1%A8/" class="post-title-link" itemprop="url">何时使用内部临时表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：15:01:40" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/37-%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%86%85%E9%83%A8%E4%B8%B4%E6%97%B6%E8%A1%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/37-%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%86%85%E9%83%A8%E4%B8%B4%E6%97%B6%E8%A1%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="何时使用内部临时表"><a href="#何时使用内部临时表" class="headerlink" title="何时使用内部临时表"></a>何时使用内部临时表</h3><h4 id="union执行流程"><a href="#union执行流程" class="headerlink" title="union执行流程"></a>union执行流程</h4><p>例子 <code>(select 1000 as f) union (select id from t1 order by id desc limit 2) </code></p>
<p>流程如下</p>
<ol>
<li>创建一个内存临时表，该临时表只有一个整型字段f，且f是主键字段</li>
<li>执行第一个子查询，得到1000这个值并存入临时表中</li>
<li>执行第二个子查询，并将查询到的内容插入到临时表中（如果查询的结果与第一个子查询的结果有重复，则会去重）</li>
<li>从临时表中按行取出数据并返回结果，删除临时表</li>
</ol>
<h4 id="group-by执行流程"><a href="#group-by执行流程" class="headerlink" title="group by执行流程"></a>group by执行流程</h4><p>例子<code>select id%10 as m,count(*) as c from t1 group by m;</code></p>
<p>流程如下：</p>
<ol>
<li>创建内存临时表，表中有两个字段m和c，主键为m；</li>
<li>扫描表t1中的索引a，依次取出叶子节点上的id值并计算id%10的结果，记为x<ul>
<li>如果临时表中没有主键为x的行，就插入记录（x,1）</li>
<li>如果有，则将该行的c加1</li>
</ul>
</li>
<li>遍历完成后，在根据字段m做排序，最终返回结果</li>
</ol>
<h5 id="优化1-使用索引"><a href="#优化1-使用索引" class="headerlink" title="优化1 使用索引"></a>优化1 使用索引</h5><p>主要思想:如果可以保证输入的数据是有序的，也就是group by m中的m是表t1的一个索引（也就是将id%10在表中构建成另外一个索引），</p>
<p><code>alter table t1 add column z int generated always as (id %10), add index(z);</code></p>
<p>那么在查询到时候就会按照0-9的顺序进行查询，那么只要相同的依次累加最终就会得到当前相同m的个数。</p>
<p>比如m的数据组成如下：</p>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20211128102053.png" alt="image-20211128102044716"></p>
<p>那么0的就有x个，1的就有y个依次类推，这样就不需要存储临时表然后排序再进行统计相同0的个数，1的个数等等。</p>
<h5 id="优化2-直接排序"><a href="#优化2-直接排序" class="headerlink" title="优化2 直接排序"></a>优化2 直接排序</h5><p>如果加索引不是很好，那么就进行直接排序。</p>
<p>主要思想如下：</p>
<ul>
<li><p>如果group by 需要统计的数据量不大，尽量只使用内存临时表，也可以通过调大<code>tmp_table_size</code>参数避免使用磁盘临时表</p>
</li>
<li><p>如果数据量很大，使用<code>SQL_BIG_RESULT</code>这个提示，告诉优化器直接使用排序算法得到的结果</p>
<p><code>select SQL_BIG_RESULT id%10 as m, count(*) as c from t1 group by m;</code></p>
<p>​    执行流程如下：</p>
<pre><code> 1. 初始化sort_buffer，放入一个整型字段m
 2. 扫描表t1的索引a，依次取出里面的id值并将id%10的值存入到sort_buffer中
 3. 扫描完成后对sort_buffer中的字段m进行排序（如果sort_buffer内存不够用，则会利用磁盘临时文件辅助排序）
 4. 排序完成后得到有序数组，结果如下图所示：
</code></pre>
<p><img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20211128102053.png" alt="image-20211128102044716"></p>
</li>
</ul>
<p>​            （这里和优化1得到的m的数据组成是一样的，注意区别在于优化1是索引结果得来的，直接取的数据就是这样子，而优化2中的直接排序是直接进行排序之后得到这样的结果）</p>
<p>​          5. 统计相同m的个数并返回结果</p>
<p>​        </p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/03-MySQL%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/03-MySQL%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">MySQL隔离机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:34:12" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/03-MySQL%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/03-MySQL%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="MySQL隔离级别"><a href="#MySQL隔离级别" class="headerlink" title="MySQL隔离级别"></a>MySQL隔离级别</h3><ul>
<li><p>在实现上，mysql会创建一个视图，访问的时候以试视图的逻辑结果为准</p>
<ul>
<li><p>可重复读</p>
<p>在事务启动时创建该视图</p>
</li>
<li><p>读提交</p>
<p>在每个SQL语句开始执行时创建</p>
</li>
<li><p>读未提交</p>
<p>没有视图概念</p>
</li>
<li><p>串行化</p>
<p>直接加锁避免并行访问</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>事务隔离的实现</p>
<p>在mysql中每条记录在更新的时候都会同时记录一条回滚操作，也就是同一条记录在系统中可以存在多个版本，也就是<font color=red>多版本并发控制</font></p>
</li>
</ul>
<h3 id="在可重复读的场景下注意事项"><a href="#在可重复读的场景下注意事项" class="headerlink" title="在可重复读的场景下注意事项"></a>在可重复读的场景下注意事项</h3><p>尽量不要使用长事务，因为长事务就意味着系统里面存在很老的事务视图（比如在事务期间不断有访问数据库的数据，那么在这个事务提交之前，数据库里面它可能用到的回滚记录必须都进行保留，这样就意味着会占用大量的存储空间）。除此之外，长事务还占用锁资源，可能会拖垮库。</p>
<p>例子：每一次的查询都是一个长连接（没有显式地进行提交），每次更新完之后（update完之后就会立刻进行提交），那么随着update的次数越来越多，长连接的越来越多，那么整体的回滚段就会越来越多</p>
<p>比如，在某个时刻（今天上午9:00）开启了一个事务A（对于可重复读隔离级别，此时一个视图read-view A也创建了），这是一个很长的事务……</p>
<p>事务A在今天上午9:20的时候，查询了一个记录R1的一个字段f1的值为1……</p>
<p>今天上午9:25的时候，一个事务B（随之而来的read-view B）也被开启了，它更新了R1.f1的值为2（同时也创建了一个由2到1的回滚日志），这是一个短事务，事务随后就被commit了。</p>
<p>今天上午9:30的时候，一个事务C（随之而来的read-view C）也被开启了，它更新了R1.f1的值为3（同时也创建了一个由3到2的回滚日志），这是一个短事务，事务随后就被commit了。</p>
<p>……</p>
<p>到了下午3:00了，长事务A还没有commit，为了保证事务在执行期间看到的数据在前后必须是一致的，那些老的事务视图、回滚日志就必须存在了，这就占用了大量的存储空间。</p>
<p>源于此，我们应该尽量不要使用长事务。</p>
<p><font color=red>注意：在使用begin开启事务的时候，只有select之后才会产生read-view，否则默认当前视图不产生read-view</font></p>
<p>建议：</p>
<p>如果考虑多一次交互问题，可以使用commit work and chain语法。在autocommit=1的情况下用begin显式启动事务，如果执行commit则提交事务。如果执行commit work and chain则提交事务并自动启动下一个事务。</p>
<h3 id="MVCC机制"><a href="#MVCC机制" class="headerlink" title="MVCC机制"></a>MVCC机制</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1hL411479T?from=search&amp;seid=78348863886178413&amp;spm_id_from=333.337.0.0">https://www.bilibili.com/video/BV1hL411479T?from=search&amp;seid=78348863886178413&amp;spm_id_from=333.337.0.0</a></p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/13-%E8%A1%A8%E5%88%A0%E9%99%A4%E4%BD%86%E8%A1%A8%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E4%B8%8D%E5%8F%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/13-%E8%A1%A8%E5%88%A0%E9%99%A4%E4%BD%86%E8%A1%A8%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E4%B8%8D%E5%8F%98/" class="post-title-link" itemprop="url">表删除但表文件大小不变</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:39:03" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/13-%E8%A1%A8%E5%88%A0%E9%99%A4%E4%BD%86%E8%A1%A8%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E4%B8%8D%E5%8F%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/13-%E8%A1%A8%E5%88%A0%E9%99%A4%E4%BD%86%E8%A1%A8%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F%E4%B8%8D%E5%8F%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>376</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><ol>
<li>使用<strong>delete</strong>表面上看是将整个表的数据删除了，实际上只是对行或者数据页标记为了<strong>可复用</strong>，并非是真正的删除操作，磁盘上的文件不会变小</li>
</ol>
<h3 id="数据空洞"><a href="#数据空洞" class="headerlink" title="数据空洞"></a>数据空洞</h3><p>可以复用但实际并未被使用的空间就是数据空洞，不仅仅删除会造成空洞，插入数据（数据页分裂）也会造成空洞，相当于是碎片</p>
<h3 id="如果解决这些问题"><a href="#如果解决这些问题" class="headerlink" title="如果解决这些问题"></a>如果解决这些问题</h3><p>执行<code>ALTER TABLE &#123;tablename&#125; ENGINE=InnoDB</code>,该命令会重建表，重新组织数据</p>
<p>几个命令</p>
<ul>
<li><p><code>alter table &#123;tablename&#125; engine=InnoDB </code></p>
<p>相当于是recreate表</p>
</li>
<li><p><code>analyze table  &#123;tablename&#125; </code></p>
<p>只对表的索引信息做重新统计，没有修改数据，过程中加了MDL读锁</p>
</li>
<li><p><code>optimize table &#123;tablename&#125;</code></p>
<p>等价于recreate+analyze</p>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/27-MySQL%E4%B8%BB%E4%BB%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/27-MySQL%E4%B8%BB%E4%BB%8E/" class="post-title-link" itemprop="url">MySQL主从</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:58:57" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/27-MySQL%E4%B8%BB%E4%BB%8E/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/27-MySQL%E4%B8%BB%E4%BB%8E/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="MySQL主从"><a href="#MySQL主从" class="headerlink" title="MySQL主从"></a>MySQL主从</h3><h4 id="在一主多从架构下，主库故障后主备切换-（主备和主从的切换原理都差不多）"><a href="#在一主多从架构下，主库故障后主备切换-（主备和主从的切换原理都差不多）" class="headerlink" title="在一主多从架构下，主库故障后主备切换 （主备和主从的切换原理都差不多）"></a>在一主多从架构下，主库故障后主备切换 （主备和主从的切换原理都差不多）</h4><ul>
<li><p>基于位点的切换</p>
<p>当从节点指向新的主节点时，需要执行一条命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO </span><br><span class="line">MASTER_HOST=$host_name </span><br><span class="line">MASTER_PORT=$port </span><br><span class="line">MASTER_USER=$user_name </span><br><span class="line">MASTER_PASSWORD=$password </span><br><span class="line">MASTER_LOG_FILE=$master_log_name</span><br><span class="line">MASTER_LOG_POS=$master_log_pos</span><br></pre></td></tr></table></figure>

<p>不可避免的就是需要设置日志偏移量，但是从节点进行切换的时候很难获取到精确的位置，并且有时候会出现发生错误的情况</p>
<p>比如说当从库已经同步了一条插入命令，但是切换的时候偏移量之后的日志也有该条命令，那么就有可能发送冲突</p>
<p>解决方法</p>
<ul>
<li>主动跳过该事物</li>
<li>设置<code>slave_skip_errors</code>参数，直接设置跳过指定的参数直到同步关系建立完成再将该参数设置为空</li>
</ul>
</li>
</ul>
<ul>
<li><p>基于gtid的切换</p>
<ul>
<li><p>gtid的定义</p>
<p>GTID=server_uuid:gno</p>
<p><code>server_uuid为当前实例的唯一标识</code></p>
<p><code>gno是事务提交时才会分配的，往往是连续的</code></p>
</li>
<li><p>主库和从库都会维护一个gtid的集合，用来表示当前该实例已经执行过的所有事务</p>
<p>具体步骤如下：（备库为实例B，主库为A‘）</p>
<ol>
<li><p> 实例 B 指定主库 A’，基于主备协议建立连接。</p>
</li>
<li><p> 实例 B 把 set_b 发给主库 A’。</p>
</li>
<li><p> 实例 A’算出 set_a 与 set_b 的差集，也就是所有存在于 set_a，但是不存在于 set_b 的 GITD 的集合，判断 A’本地是否包含了这个差集需要的所有 binlog 事务。 </p>
</li>
</ol>
<p>   a. 如果不包含，表示 A’已经把实例 B 需要的 binlog 给删掉了，直接返回错误；</p>
<p>   b. 如果确认全部包含，A’从自己的 binlog 文件里面，找出第一个不在 set_b 的事务，发给 B；</p>
<ol start="4">
<li> 之后就从这个事务开始，往后读文件，按顺序取 binlog 发给 B 去执行。</li>
</ol>
</li>
<li><p>备库如何跳过不想要的事务</p>
<p>找到主库该事物对应的gtid，执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set GTID_NEXT=&quot;server_uuid_of_Y:gno&quot;; </span><br><span class="line">begin; </span><br><span class="line">commit;</span><br><span class="line">set gtid_next=automatic;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<p>意思就是提交一个空事务并且该空事务的gtid赋值为不想要的事务的gtid，那么在同步的时候就会跳过该gtid</p>
</li>
</ul>
</li>
</ul>
<p>​        </p>
<ul>
<li><p><strong>基于位点和基于gtid的不同之处</strong></p>
<p>基于位点的是备库主动找主库要</p>
<p>基于gtid的是主库主动发给备库想要的</p>
</li>
</ul>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/36-%E7%94%A8%E6%88%B7%E4%B8%B4%E6%97%B6%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/36-%E7%94%A8%E6%88%B7%E4%B8%B4%E6%97%B6%E8%A1%A8/" class="post-title-link" itemprop="url">用户临时表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：15:01:23" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/36-%E7%94%A8%E6%88%B7%E4%B8%B4%E6%97%B6%E8%A1%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/36-%E7%94%A8%E6%88%B7%E4%B8%B4%E6%97%B6%E8%A1%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>264</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="用户临时表"><a href="#用户临时表" class="headerlink" title="用户临时表"></a>用户临时表</h3><ol>
<li><p>创建</p>
<p><code>create temporary table(xxxx)</code></p>
</li>
<li><p>性质</p>
<ul>
<li>临时表可以同名，只要不在同一个session里面</li>
<li>临时表会在session自动释放之后自动删除</li>
<li>临时表的操作会传递给备库，<font color=red>只有当binlog_format=statment/mixed</font>才会进行传递</li>
<li>对于备库来说，应用日志线程都是共用的，那么如何实现临时表可以同名呢？因为在记录binlog的时候会将该语句执行的主库线程id写到binlog中</li>
</ul>
</li>
<li><p>注意</p>
<p>临时表的自动回收主要用于session异常断开，MySQL异常重启，对于由线程池来操作的连接还是需要主动进行临时表的删除</p>
</li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/02-MySQL%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/02-MySQL%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">MySQL更新流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:33:41" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/02-MySQL%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/02-MySQL%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>617</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="mysql-数据更新流程"><a href="#mysql-数据更新流程" class="headerlink" title="mysql 数据更新流程"></a>mysql 数据更新流程</h2><p>1、执行器先从引擎中找到数据，如果在内存则直接返回，如果不在内存查询后返回<br>2、执行器拿到数据后，会先修改数据，然后调用引擎接口重新写入数据<br>3、引擎将数据更新到内存，同时写入redo log，此时处于prepare状态<br>4、执行器生成这个操作的binlog<br>5、执行器调用引擎的事务提交接口，将redo状态改成commit状态，更新完成</p>
<p>InnoDB如何保证redolog的完整性？ - 假装懂编程的回答 - 知乎 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/368847138/answer/2161671813">https://www.zhihu.com/question/368847138/answer/2161671813</a></p>
<h3 id="mysql-crash恢复"><a href="#mysql-crash恢复" class="headerlink" title="mysql crash恢复"></a>mysql crash恢复</h3><p>通过两段式提交我们知道redo log和binlog在各个阶段会被打上prepare或者commit的标识，同时还会记录事务的XID，有了这些数据，在数据库重启的时候，会先去redo log里检查所有的事务，如果redo log的事务处于commit状态，那么说明在commit后发生了crash，此时直接把redo log的数据恢复就行了，如果redo log是prepare状态，那么说明commit之前发生了crash，此时binlog的状态决定了当前事务的状态，如果binlog中有对应的XID，说明binlog已经写入成功，只是没来的及提交，此时再次执行commit就行了，如果binlog中找不到对应的XID，说明binlog没写入成功就crash了，那么此时应该执行回滚。</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/12-MySQL%E6%8A%96%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/12-MySQL%E6%8A%96%E5%8A%A8/" class="post-title-link" itemprop="url">MySQL抖动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:38:13" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/12-MySQL%E6%8A%96%E5%8A%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/12-MySQL%E6%8A%96%E5%8A%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>572</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="redo-log的flush导致mysql抖一下"><a href="#redo-log的flush导致mysql抖一下" class="headerlink" title="redo log的flush导致mysql抖一下"></a>redo log的flush导致mysql抖一下</h3><ol>
<li><p>redo log的写flush脏页时机</p>
<ul>
<li>redo log写满了，需要flush脏页</li>
<li>内存不够用，需要flush脏页</li>
<li>mysql空闲时候</li>
<li>mysql关机时候</li>
</ul>
</li>
<li><p>mysql刷脏页的控制策略</p>
<ul>
<li><p>需要正确的告诉innodb所在主机的io能力，这样innodb才知道全力刷脏页的时候可以有多快</p>
<p><code>show variables like &#39;%innodb_io_capacity%&#39;;</code></p>
<p>一般是利用fio通过测试磁盘随机读写命令来进行设置，尤其是当磁盘为ssd的时候需要对该数值进行设置</p>
</li>
<li><p>innodb知道了主机的io能力不能总是全力去刷，也需要对其进行控制比例，控制比例计算如下</p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20211026101856.png" alt="image-20211026101614652" style="zoom:50%;" /></li>
</ul>
</li>
<li><p>如何解决这个问题？</p>
<ul>
<li><p>多关注脏页比例，不要让其经常接近75%</p>
</li>
<li><p>在使用ssd磁盘的时候（IOPS比较高），建议将<code>innodb_flush_neighbors</code>设置为0</p>
<p><code>innodb_flush_neighbors</code>默认为1，表示在准备刷一个脏页的时候，其旁边也有一个脏页，就会将旁边的脏页刷掉，同时旁边的脏页的旁边如果也有脏页也不被刷，一直重复下去直到没有脏页，有点像“连坐”，对于机械硬盘很有效果，可以减少很多随机IO，但是对于ssd这种就不需要这种机制了</p>
</li>
<li><p>正确的告诉innodb所在主机的io能力，设置innodb_io_capacity</p>
</li>
<li><p>redo log不能设置太小</p>
</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/06%E5%85%A8%E5%B1%80%E9%94%81%E5%92%8C%E8%A1%A8%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/06%E5%85%A8%E5%B1%80%E9%94%81%E5%92%8C%E8%A1%A8%E9%94%81/" class="post-title-link" itemprop="url">全局锁和表锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:35:23" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/06%E5%85%A8%E5%B1%80%E9%94%81%E5%92%8C%E8%A1%A8%E9%94%81/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/06%E5%85%A8%E5%B1%80%E9%94%81%E5%92%8C%E8%A1%A8%E9%94%81/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>271</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h3><h4 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h4><p>表锁可以有读锁和写锁，读锁只与写锁之间相互排斥，写锁与所有锁都排斥</p>
<p>语法：</p>
<p><code>lock tables t1 read/write</code></p>
<p><code>unlock tables</code></p>
<h4 id="元数据锁（MDL）"><a href="#元数据锁（MDL）" class="headerlink" title="元数据锁（MDL）"></a>元数据锁（MDL）</h4><p>不需要显式使用，在访问一个表的时候会自动加上该锁。</p>
<p>元数据锁的作用在于在你对表进行查询的时候，阻止对表的结构进行更改</p>
<p>当对一个表进行增删改查的时候会加入MDL读锁</p>
<p>当对一个表进行结构变更操作的时候加入MDL写锁</p>
<p><font color=red>注意：即使是一个小表也会引发数据库的崩溃</font></p>
<img src="https://raw.githubusercontent.com/CooperXJ/ImageBed/master/img/20211022095059.png" alt="image-20211022095043295" style="zoom:50%;" />

<p>这种情况下由于sessionA的事务导致sessionC需要MDL写锁因此阻塞，但是之后的sessionD获取MDL读锁也会被阻塞</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/22-MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/22-MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">MySQL性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:43:52" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/22-MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/22-MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>短连接风暴</p>
<ul>
<li><p>出现原因</p>
<p>mysql建立连接的成本很高，除了正常的网络连接三次握手外，还需要做登陆权限判断和获得这个连接的数据读写权限</p>
</li>
<li><p>解决方法</p>
<ul>
<li><p>kill 掉占着连接但是不工作的线程</p>
<p>设置<code>wait_timeout</code>参数</p>
<p>这里需要注意一下如果连接数过多，应当<strong>优先断开事务外空闲太久的连接</strong>，实在不行再断开事务内空闲太久的连接</p>
<p>（查看该连接事务在事务内：<code>select * from information_schema.innodb_trx</code>）</p>
<p><font color=red>注意：当mysql主动断开一个连接之后，有些应用端收到错误之后并不会重新连接，而是会直接复用这个已经不能复用的句柄进行重试。例如在springboot与druid结合的时候，默认spring.datasource.testOnBorrow=false，当连接池中的连接被数据库主动关闭了，如果这些连接不被其他线程会受到 话，它们不会被连接池废除，也不会重新被创建，占用连接池的名额</font></p>
<p>SpringBoot中的属性：</p>
<ul>
<li><code>spring.datasource.testOnBorrow</code>:当从连接池借用连接时，是否测试该连接（会对性能有一些损耗）自动进行重连</li>
</ul>
<p>​       在durid中，默认为false</p>
<p>​       在mybatis中默认为true</p>
<p>​        <a target="_blank" rel="noopener" href="https://blog.csdn.net/zhanlai_wei/article/details/78139511">参考</a></p>
<ul>
<li><p><code>spring.datasource.validation-query指定获取连接时连接校验的sql查询语句</code></p>
<p>在mysql上就是<code>spring.datasource.validationQuery=SELECT 1</code>(不同数据库右边不同)</p>
</li>
</ul>
</li>
<li><p>减少连接过程的消耗</p>
<p>跳过权限验证</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>慢查询性能问题</p>
<ul>
<li><p>索引未设计好</p>
<p>解决方法：</p>
<ol>
<li>在备库上执行<code>set sql_log_bin=off</code>,再在备库上添加索引</li>
<li>最后执行主备切换</li>
<li>在当前备库上执行<code>set sql_log_bin=off</code>，然后添加索引</li>
</ol>
</li>
<li><p>SQL未写好</p>
<p>如果MySQL版本是5.7以及以上的版本，可以采用<code>query_rewrite</code>功能</p>
<p>也就是可以将线上执行的索引替换掉</p>
</li>
<li><p>MySQL选错了索引</p>
</li>
</ul>
</li>
</ol>
<ol start="3">
<li><p>QPS突增问题</p>
<ul>
<li>全新业务bug导致的，如果是白名单一个一个加的，那么可以直接将全新业务对应的白名单去掉</li>
<li>如果新功能使用的是单独数据库用户，那么可以将这个用户删掉，然后断开现有连接</li>
<li>如果是和主体功能绑定到一起的，通过<code>query_rewrite</code>将sql语句直接写成select 1</li>
</ul>
<p>我觉得最重要的一点是<strong>业务和数据库一一对应，最好每一个业务对应一个用户</strong></p>
</li>
<li><p>出现大事务磁盘占满的情况</p>
<p>有可能是因为事务过大，导致binlog在落盘的时候出现问题</p>
<p>注意这个流程都是对于一个事物来讲的。一旦事物提交，binlog cache和binlog 临时文件都会释放掉，因为binlog已经固化到了binlog file。同时如果事物中包含多个DML语句，那么他们共享的一套的binlog cache和binlog 临时文件。</p>
<ol>
<li>事物开启。</li>
<li>执行dml语句，在dml语句第一次执行的时候会分配内存空间binlog cache。</li>
<li>执行dml语句期间生成的event不断写入到binlog cache。</li>
<li>如果binlog cache的空间已经满了，则将binlog cache的数据写入到binlog临时文件，同时清空binlog cache。如果binlog临时文件的大小大于了max_binlog_cache_size的设置则抛错ERROR 1197 (HY000)。</li>
<li>事物提交，整个binlog cache和binlog临时文件数据全部写入到binlog file中进行固化，释放binlog cache和binlog临时文件。但是注意此时binlog cache的内存空间留用供下次事物使用，但是binlog临时文件被截断为0，保留文件描述符。其实也就是IO_CACHE(参考后文)保留，并且保留IO_CACHE中的分配的内存空间，和物理文件描述符。</li>
<li>断开连接，这个过程会释放IO_CACHE同时释放其持有的binlog cache内存空间以及持有的binlog 临时文件。</li>
</ol>
</li>
</ol>
<ol start="5">
<li><p>如果一个数据库是被客户端的压力打满导致无法响应，那么重启数据库是没有用的</p>
<p>因为重启之后业务请求还是会继续进行发送，而由于重启，buffer pool被清空，可能会导致语句执行得更慢</p>
</li>
</ol>
<ol start="6">
<li>如果一个表上出现多个单字段索引，可能会出现优化器选择索引合并算法的线下，但是实际上，索引合并算法效率并不好，最好将其中的一个索引改为联合索引的方法比较好</li>
</ol>
<ol start="7">
<li><p>客户端程序的连接器，连接器完成会做一些诸如show columns的操场，在短连接模式下影响非常大</p>
<p>我们在review项目的时候不仅review业务代码，也需要review连接器的行为，一般做法就是在测试环境中将general_log打开，用业务行为触发连接，通过general log分析连接器的行为</p>
</li>
</ol>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cooperxj.github.io/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/29-%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E6%9F%90%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%AF%E5%90%A6%E5%87%BA%E7%8E%B0%E4%BA%86%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cooper">
      <meta itemprop="description" content="记录一些学习笔记、小说、随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cooper Notes">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/29-%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E6%9F%90%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%AF%E5%90%A6%E5%87%BA%E7%8E%B0%E4%BA%86%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">如何判断某一个数据库是否出现了问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-07 08:43:38 / 修改时间：14:59:44" itemprop="dateCreated datePublished" datetime="2022-01-07T08:43:38+08:00">2022-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/29-%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E6%9F%90%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%AF%E5%90%A6%E5%87%BA%E7%8E%B0%E4%BA%86%E9%97%AE%E9%A2%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/01/07/MySQL/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/29-%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E6%9F%90%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%AF%E5%90%A6%E5%87%BA%E7%8E%B0%E4%BA%86%E9%97%AE%E9%A2%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>768</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="如何判断某一个数据库是否出现了问题"><a href="#如何判断某一个数据库是否出现了问题" class="headerlink" title="如何判断某一个数据库是否出现了问题"></a>如何判断某一个数据库是否出现了问题</h3><h4 id="select-1判断"><a href="#select-1判断" class="headerlink" title="select 1判断"></a>select 1判断</h4><p>缺点：只能说明该库所在的进程还在，但是无法说明主库没有问题</p>
<p>比如说mysql的并发查询的上限是3，那么select 1作为第四个接入进来的时候是可以直接返回的，但是实际上现在的并发查询已经达到了最大值</p>
<p><font color=red>注意：并发查询和并发连接是有区别的，当锁进入等待以后，并发线程的计数会-1</font></p>
<p>通常情况下，<code>innodb_thread_concurrency</code>设置为64-128之间最好，值为0表示不作限制</p>
<h4 id="查表判断"><a href="#查表判断" class="headerlink" title="查表判断"></a>查表判断</h4><p>比如<code>select * from mysql.health_check</code></p>
<p>通过该方法可以检测出由于并发线程过多导致的数据库不可用</p>
<p>缺点：无法知道空间是否满了</p>
<h4 id="更新判断"><a href="#更新判断" class="headerlink" title="更新判断"></a>更新判断</h4><p><code>update mysql.health_check set t_modified=now();</code></p>
<p>可以通过该方法对存储空间进行判断，如果满了会阻塞</p>
<p>对于双主模式下的更新判断，需要注意不能让主备之间的更新产生冲突,如果主库和备库都是用相同的更新命令，就可能会出现行冲突，导致主备同步停止</p>
<p><code>insert into mysql.health_check(id, t_modified) values (@@server_id, now()) on duplicate key update</code></p>
<p>缺点：当系统的IO资源很少了，但是利用更新判断这些语句去检查耗费的资源比较少，因此可能无法察觉异常</p>
<h4 id="内部统计"><a href="#内部统计" class="headerlink" title="内部统计"></a>内部统计</h4><p>查询<code>file_summary_by_event_name</code>中的</p>
<p><code>event_name=&#39;wait/io/file/innodb/innodb_log_file</code>（redo log情况）</p>
<p><code>event_name = &quot;wait/io/file/sql/binlog&quot;</code> （binlog情况）</p>
<p>可以通过<code>MAX_TIMER_WAIT</code>来判断IO请求时间是否超时</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>考虑利用更新判断与内部统计相结合</p>

      
    </div>

    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/35/">35</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cooper</p>
  <div class="site-description" itemprop="description">记录一些学习笔记、小说、随笔</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">341</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/CooperXJ" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;CooperXJ" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1789023580@qq.com" title="E-Mail → mailto:1789023580@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cooper</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">648k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:49</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'rOzi1T6uncSYNdx0tp1owOzV-gzGzoHsz',
      appKey     : 'Fk3s6CQBK042e1QltClHnTBP',
      placeholder: "留下邮箱，有回复时你将收到提醒，邮箱不会被公开",
      avatar     : 'wavatar',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
